<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="google-site-verification" content="-uZHm8AUDAmSwKTke81VW3xPlRJEYMmlE7tCSMMMEq0" />
<meta name="google-site-verification" content="IfXi5MoE4fDKJjD9_vKVC_X2q1N1Lk8KCJ0C5UFMwxQ" />
  <title>Daily Finance | Personal Budget & Expense Tracker App</title>

<meta name="description" content="Securely track your daily income and expenses. This mobile-friendly Personal Budgeting and Expense Tracker helps you achieve financial autonomy and manage your money better. Data is saved locally in your browser.">

<link rel="canonical" href="https://dailyfinances.netlify.app/" />

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

<style>
  :root{
    --primary:#0b5ed7; /* deep blue */
    --accent:#3b82f6;
    --bg-light:#f7fafc;
    --bg-dark:#0f1724;
    --card-light:#ffffff;
    --card-dark:#0b1220;
    --text-light:#0b1224;
    --text-dark:#e6eef8;
    --muted:#6b7280;
    --success:#10b981;
    --danger:#ef4444;
    --warning:#f59e0b;
    --radius:12px;
    --border-color: rgba(15, 23, 42, 0.06); /* Default light mode border */
  }
  [data-theme="dark"]{
    --bg:var(--bg-dark);
    --card:var(--card-dark);
    --text:var(--text-dark);
    --border-color: rgba(255, 255, 255, 0.1);
  }
  [data-theme="light"]{
    --bg:var(--bg-light);
    --card:var(--card-light);
    --text:var(--text-light);
  }

  *{box-sizing:border-box;font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);transition:background .25s,color .25s;}
  header{
    position:sticky; top:0; z-index:20;
    background:linear-gradient(90deg,var(--primary),var(--accent));
    color:#fff; padding:14px 18px; display:flex; align-items:center; gap:12px; box-shadow:0 6px 18px rgba(11,78,203,0.12);
    border-bottom-left-radius:0; border-bottom-right-radius:0;
  }
  .logo{
    display:flex; align-items:center; gap:10px;
    max-width: 70%;
  }
  .logo svg{width:36px;height:36px;flex:0 0 36px;border-radius:8px;background:rgba(255,255,255,0.08); padding:4px;}
  
  /* SEO Improvement 3: H1 styling for semantic correctness */
  .logo h1 { 
    margin: 0; 
    font-weight:700; 
    font-size:1.1rem; /* Match original span size */
    color: #fff; /* Ensure H1 stays white in header */
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    min-width: 0; /* Added for better mobile responsiveness */
  }
  /* NEW VIP Feature: Greeting */
  .greeting {
      font-size: 0.9rem;
      font-weight: 500;
      color: rgba(255, 255, 255, 0.8);
      margin-left: 20px;
      /* NEW: Adjust spacing for small screens */
      display: none; 
  }
  @media(min-width: 768px) {
    .greeting {
      display: block;
    }
  }

  /* NEW VIP Feature: Settings Icon */
  .settings-icon {
      margin-left: 10px;
      cursor: pointer;
  }
  
  .container{max-width:1100px;margin:18px auto;padding:0 14px 80px;}
  .top-actions{display:flex; gap:12px; align-items:center; justify-content:space-between; margin-bottom:14px; flex-wrap:wrap;}
  .theme-toggle, #settings-btn{background:var(--card);border:none;padding:8px 10px;border-radius:999px;cursor:pointer;box-shadow:0 3px 10px rgba(2,6,23,0.06);}
  form{background:var(--card);padding:14px;border-radius:var(--radius);box-shadow:0 4px 18px rgba(2,6,23,0.06);margin-bottom:16px;}
  .grid{display:grid; grid-template-columns:repeat(2,1fr); gap:14px;}
  @media(max-width:880px){ .grid{grid-template-columns:1fr;} .top-actions{gap:8px;}}
  /* MODIFIED: Changed form-row to use 2 columns grid for better layout on desktop/tablet */
  .form-row{display:grid; grid-template-columns:1fr 1fr; gap:10px;}
  @media(max-width:520px){ .form-row{grid-template-columns:1fr;} }
  
  /* REMOVED: .amount-input-group and .quick-add-buttons styling */
  .amount-input-group {
    display: block; /* Ensures single input takes full width */
  }

  /* NEW: Budget Alert Styling */
  #budget-alert {
    font-size: 0.85rem;
    padding: 6px 10px;
    margin-top: 5px;
    border-radius: 6px;
    display: none; /* Show only when active */
    font-weight: 500;
  }
  .budget-good { background: rgba(16, 185, 129, 0.1); color: var(--success); }
  .budget-warning { background: rgba(245, 158, 11, 0.1); color: var(--warning); }
  .budget-danger { background: rgba(239, 68, 68, 0.1); color: var(--danger); }

  input[type="text"], input[type="number"], input[type="date"], input[type="password"], select, button{
    padding:10px 12px; font-size:0.95rem; border-radius:8px; border:1px solid var(--border-color); width:100%;
    background:transparent; color:inherit;
  }
  button.primary{background:var(--primary); color:#fff; border:none; cursor:pointer; font-weight: 600;}
  button.ghost{background:transparent; border:1px solid var(--border-color); font-weight: 500;}
  .flex{display:flex; gap:8px; align-items:center; flex-wrap: wrap;} /* Added flex-wrap */
  .flex button{padding:10px 12px;}
  .card{background:var(--card); padding:14px; border-radius:var(--radius); box-shadow:0 4px 12px rgba(2,6,23,0.04);}
  .summary{display:flex; gap:12px; margin-bottom:16px; flex-wrap:wrap; justify-content: space-between;}
  .summary .stat{flex:1; min-width: 140px; text-align:left; padding:12px; border: 1px solid var(--border-color);}
  /* H3s in the summary section serve as important sub-headings */
  .stat h3{margin:0;font-size:0.9rem;color:var(--muted); text-transform: uppercase;}
  /* Original P styling */
  .stat p{margin:6px 0 0;font-weight:700;font-size:1.25rem;}

  /* --- NEW STYLING FOR TREND ANALYSIS --- */
  .stat .value-row {
    display: flex;
    justify-content: space-between;
    align-items: flex-end;
    margin: 6px 0 0;
  }
  .stat .value-row p {
    margin: 0;
    font-weight: 700;
    font-size: 1.25rem;
  }
  .trend-badge {
    font-size: 0.8rem;
    padding: 2px 6px;
    border-radius: 6px;
    font-weight: 600;
    white-space: nowrap;
    line-height: 1.2;
    margin-left: 8px; /* Added spacing */
  }
  .trend-good {
    background: rgba(16, 185, 129, 0.12);
    color: var(--success);
  }
  .trend-bad {
    background: rgba(239, 68, 68, 0.08);
    color: var(--danger);
  }
  .trend-neutral {
    background: rgba(107, 114, 128, 0.1);
    color: var(--muted);
  }
  /* -------------------------------------- */


  /* Expenses table */
  .table-wrap{overflow:auto;border-radius:10px;}
  table{width:100%;border-collapse:collapse;min-width:760px;}
  /* NEW: Min-width for table to avoid squishing on smaller phones */
  @media(max-width: 760px) {
    table{ min-width: 900px; } 
  }
  th, td{padding:12px 14px;text-align:left;border-bottom:1px solid var(--border-color);}
  th{background:var(--primary); color:#fff; position:relative; font-weight:700;}
  .badge{display:inline-block;padding:6px 10px;border-radius:999px;font-size:0.8rem; font-weight:600;}
  .badge.income{background:rgba(16,185,129,0.12); color:var(--success); border:1px solid rgba(16,185,129,0.18);}
  .badge.expense{background:rgba(239,68,68,0.08); color:var(--danger); border:1px solid rgba(239,68,68,0.12);}
  .actions button{margin-right:8px;padding:6px 10px;border-radius:6px;border:1px solid var(--border-color);cursor:pointer;background:transparent;}
  .muted{color:var(--muted);font-size:0.9rem;}
  /* MODIFIED: Removed kachra from footer */
  footer{margin-top:30px;padding:14px;text-align:center;color:var(--muted); border-top: 1px solid var(--border-color);}

  /* small UI tweaks */
  .small{font-size:0.85rem;}
  .charts{display:grid; grid-template-columns:1fr 1fr; gap:14px;}
  /* Added a third column for the new Monthly Bar Chart */
  @media(min-width:1100px){ .charts{grid-template-columns:1fr 1fr 1fr;} } 
  @media(max-width:1100px){ .charts{grid-template-columns:1fr 1fr;} }
  @media(max-width:760px){ .charts{grid-template-columns:1fr;} }

  /* Custom Message Box */
  #modal-overlay, #lock-screen, #settings-modal {
    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0, 0, 0, 0.7); z-index: 1000;
    display: none;
    align-items: center; justify-content: center;
  }
  #confirm-modal, #settings-modal-content {
    background: var(--card); color: var(--text); padding: 20px;
    border-radius: var(--radius); width: 90%; max-width: 400px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
  }
  #confirm-modal h4 { margin-top: 0; color: var(--primary); }
  #modal-buttons {
    display: flex; justify-content: flex-end; gap: 10px; margin-top: 15px;
  }
  #modal-buttons button { width: auto; padding: 8px 15px; }
  #modal-buttons .confirm { background: var(--danger); color: white; border: none; }

  /* New status card styling */
  .stat-status {
    border: none !important;
    text-align: center !important;
    padding: 18px 12px;
  }
  .stat-status h3 {
    font-size: 1.0rem;
    color: var(--text);
  }
  .stat-status p {
    font-size: 1.5rem;
    font-weight: 900;
  }
  .status-good { background: var(--success); color: #fff; }
  .status-moderate { background: var(--warning); color: var(--text-dark); }
  .status-poor { background: var(--danger); color: #fff; }
  
  /* Loading Indicator */
  #loading-indicator {
    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(255, 255, 255, 0.8); z-index: 999;
    display: flex; align-items: center; justify-content: center;
    font-size: 1.2rem; font-weight: 600; color: var(--primary);
  }
  
  /* Ad-specific CSS for centering - Keeping the style but removing the ad */
  .ad-container {
    display: flex;
    justify-content: center;
    margin: 15px 0; /* Add vertical spacing */
  }

  /* NEW VIP Feature: Goal Tracker Styling */
  .goal-progress-bar {
      height: 10px;
      background: var(--border-color);
      border-radius: 5px;
      margin-top: 6px;
      overflow: hidden;
  }
  .goal-progress {
      height: 100%;
      background: var(--primary);
      transition: width 0.5s ease-in-out;
  }
  /* NEW VIP Feature: Lock Screen Styling */
  #lock-screen {
      background: var(--bg);
      z-index: 1010;
      flex-direction: column;
  }
  #lock-screen-content {
      text-align: center;
      padding: 30px;
      border-radius: var(--radius);
      background: var(--card);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
  }
  #pin-input {
      margin-top: 15px;
      text-align: center;
      letter-spacing: 5px;
  }

  /* NEW: Search Highlight Style */
  .search-highlight {
      background-color: var(--warning);
      color: var(--text-light); /* Ensure text is visible on highlight */
      padding: 1px 3px;
      border-radius: 3px;
  }
  /* REMOVED: Tag Suggestions styling */
</style>
</head>
<body data-theme="light">

<div id="lock-screen" style="display: none;">
    <div id="lock-screen-content">
        <h2 id="lock-title" style="margin-top: 0; color: var(--primary);">üîí App Locked</h2>
        <p id="lock-message">Enter your PIN to continue.</p>
        <input type="password" id="pin-input" placeholder="Enter PIN" maxlength="4" />
        <p id="pin-error" style="color: var(--danger); font-size: 0.9rem; height: 20px; margin: 5px 0 0;"></p>
        <button id="unlock-btn" class="primary" style="margin-top: 15px;">Unlock</button>
    </div>
</div>

<div id="loading-indicator" style="display: none;">
  <p id="loading-text">Loading Data...</p>
</div>

<div id="settings-modal">
    <div id="settings-modal-content">
        <h3 id="settings-title" style="margin-top: 0; color: var(--primary);">‚öôÔ∏è App Settings</h3>
        
        <label id="label-currency" for="currency-select" style="display: block; margin-top: 10px;">**1. Base Currency**</label>
        <select id="currency-select" style="margin-bottom: 15px;">
        </select>
        
        <label id="label-date-format" for="date-format-select" style="display: block;">**2. Date Format**</label>
        <select id="date-format-select" style="margin-bottom: 15px;">
            <option value="DD/MM/YYYY">DD/MM/YYYY</option>
            <option value="MM/DD/YYYY">MM/DD/YYYY</option>
        </select>

        <label id="label-goal" for="goal-input" style="display: block;">**3. Monthly Expense (Current Currency)**</label>
        <input type="number" id="goal-input" placeholder="e.g., 20000" style="margin-bottom: 15px;" min="0" />

        <label id="label-category-budget" for="category-budget-list" style="display: block; margin-top: 10px;">**4. Category Monthly Budgets**</label>
        <div id="category-budget-list" style="max-height: 150px; overflow-y: auto; border: 1px solid var(--border-color); padding: 8px; border-radius: 6px; margin-bottom: 15px;">
        </div>
        
        <label id="label-set-pin" for="set-pin" style="display: block;">**5. Set/Change PIN (4 Digits)**</label>
        <input type="password" id="set-pin" placeholder="Enter new 4-digit PIN" maxlength="4" />
        <button id="save-settings-btn" class="primary" style="margin-top: 15px; width: 100%;">Save Settings</button>
        <button id="close-settings-btn" class="ghost" style="margin-top: 10px; width: 100%;">Close</button>
    </div>
</div>

<div id="modal-overlay">
  <div id="confirm-modal">
    <h4 id="modal-title">Confirm Action</h4>
    <p id="modal-message">Are you sure you want to proceed?</p>
    <div id="modal-buttons">
      <button id="modal-cancel" class="ghost">Cancel</button>
      <button id="modal-confirm" class="confirm">Confirm</button>
    </div>
  </div>
</div>

<header>
  <div class="logo" aria-hidden="true">
    <svg viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="logo">
      <rect x="2" y="2" width="44" height="44" rx="10" fill="white" opacity="0.06"/>
      <path d="M14 32c3-4 9-6 14-6" stroke="white" stroke-width="2.8" stroke-linecap="round" stroke-linejoin="round"/>
      <path d="M14 24c3-4 9-6 14-6" stroke="#CDE4FF" stroke-width="2.8" stroke-linecap="round" stroke-linejoin="round"/>
      <circle cx="36" cy="14" r="6" fill="#fff" opacity="0.12"/>
      <path d="M33.5 15.5L38.5 12.5" stroke="#fff" stroke-width="1.6" stroke-linecap="round"/>
    </svg>
    <h1 id="app-title" title="Daily Finance">Daily Finance</h1>
  </div>
  <span id="header-greeting" class="greeting">Hello, Daily Finance User!</span>

  <div style="margin-left:auto; display:flex; gap:10px; align-items:center;">
    <button class="theme-toggle settings-icon" id="settings-btn" title="Settings">‚öôÔ∏è</button>
    <button class="theme-toggle" id="theme-btn" title="Toggle theme">üåì</button>
  </div>
</header>

<div class="container">

  <div class="top-actions">
    <p id="data-storage-info" class="muted small" style="margin:0;">
      Financial autonomy at your fingertips. Data is stored securely in your browser's Local Storage.
    </p>
    <p id="filtered-total" class="muted small" style="margin:0; font-weight: 600;"></p>
    <div class="flex">
      <button id="delete-selected-txns" class="ghost small" style="display: none;">Delete Selected</button>
      <button id="export-pdf" class="ghost small">Export PDF üìÑ</button>
      <button id="export-csv" class="ghost small">Export CSV</button>
      <button id="import-json" class="ghost small">Import Data üíæ</button>
      <button id="clear-all" class="ghost small">Clear All Data</button>
    </div>
  </div>

  <div class="ad-container">
    </div>
  
  <div class="summary">
    <div class="card stat">
      <h3 id="stat-net-worth-h">Net Worth (Overall)</h3>
      <div class="value-row">
        <p id="net-worth">‚Çπ0.00</p>
        <span id="net-worth-trend" class="trend-badge trend-neutral" style="display: none;">--</span>
      </div>
    </div>
    <div class="card stat">
      <h3 id="stat-monthly-income-h">Monthly Income</h3>
      <div class="value-row">
        <p id="monthly-income-stat">‚Çπ0.00</p>
        </div>
    </div>
    <div class="card stat">
      <h3 id="stat-income-h">Total Income (Current)</h3>
      <div class="value-row">
        <p id="total-income">‚Çπ0.00</p>
        <span id="income-trend" class="trend-badge trend-neutral" style="display: none;">--</span>
        </div>
    </div>
    <div class="card stat">
      <h3 id="stat-expense-h">Total Expense (Current)</h3>
      <div class="value-row">
        <p id="total-expense">‚Çπ0.00</p>
        <span id="expense-trend" class="trend-badge trend-neutral" style="display: none;">--</span>
        </div>
    </div>
    <div id="savings-rate-card" class="card stat stat-status status-good">
      <h3 id="stat-savings-rate-h">Monthly Savings Rate</h3>
      <p id="savings-rate">0%</p>
    </div>
    <div id="avg-daily-expense-card" class="card stat">
      <h3 id="stat-avg-expense-h">Avg. Daily Expense</h3>
      <p id="avg-daily-expense">‚Çπ0.00</p>
    </div>
    <div id="highest-expense-card" class="card stat">
      <h3 id="stat-highest-expense-h">Highest Expense (This Mo.)</h3>
      <p id="highest-expense">‚Çπ0.00</p>
      <p class="muted small" id="highest-expense-desc"></p>
    </div>
    <div id="monthly-goal-card" class="card stat" style="min-width: 200px;">
        <h3 id="stat-goal-h">Monthly Expense</h3>
        <p id="goal-status-text">Goal: N/A</p>
        <div class="goal-progress-bar">
            <div id="goal-progress-bar-fill" class="goal-progress" style="width: 0%; background: var(--warning);"></div>
        </div>
        <p class="muted small" id="goal-remaining" style="margin: 4px 0 0;">‚Çπ0.00 / ‚Çπ0.00 Spent</p>
    </div>
  </div>

  <div class="grid">
    <form id="tx-form" class="card" autocomplete="off">
      <h3 id="form-title" style="margin-top:0;">Record Transaction</h3>
      <div class="form-row">
        <select id="tx-type" required>
          <option value="expense">Expense (Outflow)</option>
          <option value="income">Income (Inflow)</option>
        </select>
        <div class="amount-input-group">
          <input id="amount" type="number" placeholder="Amount (in base currency)" step="0.01" required /> 
          </div>
      </div>

      <div class="form-row" style="margin-top:8px;">
        <select id="category" required>
          <option value="">Select Category</option>
        </select>
        <input id="description" type="text" placeholder="Description / Vendor" />
      </div>

      <p id="budget-alert" class="budget-good">Budget Left: 100%</p>

      <div class="form-row" style="margin-top:8px;">
        <input id="date" type="date" placeholder="Date" /> 
        <select id="recurring">
          <option value="None">Frequency: None</option>
          <option value="Daily">Daily</option>
          <option value="Weekly">Weekly</option>
          <option value="Monthly">Monthly</option>
        </select>
      </div>
      
      <div class="form-row" style="margin-top:8px;">
          </div>

      <div style="margin-top:10px; display:flex; gap:8px;">
        <button id="commit-btn" type="submit" class="primary">Commit Transaction</button>
        <button type="button" id="cancel-edit" class="ghost">Cancel Edit</button>
      </div>
    </form>
    
    <div>
      
      <form id="category-form" class="card small">
        <h3 id="category-form-title" style="margin:0 0 8px 0;">Category Management</h3>
        <div style="display:flex; gap:8px; margin-bottom: 8px;">
          <input id="new-category" type="text" placeholder="Add New Category" required />
          <select id="new-category-type" style="width: auto; flex: 0 0 100px;">
            <option value="expense">Expense</option>
            <option value="income">Income</option>
          </select>
          <button id="add-category-btn" type="submit" class="primary" style="flex: 0 0 50px;">Add</button>
        </div>
        <p id="category-list-info" class="muted small" style="margin: 0;"></p>
      </form>

      <div class="ad-container">
         </div>
      
      <div class="charts" style="margin-top:14px;">
        <div class="card">
          <h3 id="chart-expense-title" style="margin-top:0;">Expense Allocation</h3>
          <canvas id="expense-chart"></canvas>
        </div>
        <div class="card">
          <h3 id="chart-income-title" style="margin-top:0;">Income Distribution</h3>
          <canvas id="income-chart"></canvas>
        </div>
        <div class="card">
            <h3 id="chart-netflow-title" style="margin-top:0;">Monthly Net Flow (6 Mo.)</h3>
            <canvas id="monthly-bar-chart"></canvas>
        </div>
      </div>
      
      </div>
  </div>
  
  <div class="card" style="margin-top:8px;">
    <h3 id="register-title" style="margin-top:0;">Transaction Register</h3>
    <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:10px;">
      <input id="search" type="text" placeholder="Search Description/Category" style="min-width:180px;" />
      <select id="filter-month" style="width: auto; min-width: 100px;">
        <option value="">All Months</option>
        <option value="Current">This Month</option>
      </select>
      <select id="filter-year" style="width: auto; min-width: 100px;">
        <option value="">All Years</option>
      </select>
      <select id="filter-type">
        <option value="">All Types</option>
        <option value="income">Income</option>
        <option value="expense">Expense</option>
      </select>
      <select id="filter-category">
        <option value="">All Categories</option>
      </select>
      <input id="from" type="date" title="Filter from start date" style="width: 130px; min-width: 0;" />
      <input id="to" type="date" title="Filter to end date" style="width: 130px; min-width: 0;" />
      <input id="min-amount" type="number" placeholder="Min Amount" min="0" step="0.01" style="width: 100px; min-width: 0;" />
      <input id="max-amount" type="number" placeholder="Max Amount" min="0" step="0.01" style="width: 100px; min-width: 0;" />
      <button id="view-month" class="primary">View This Month</button>
      <button id="apply-filter" class="ghost">Apply Filters</button>
      <button id="reset-filter" class="ghost">Reset Filters</button>
    </div>

    <div class="table-wrap card" style="padding:0;">
      <table id="tx-table" role="grid" aria-label="Transactions register">
        <thead>
          <tr>
            <th style="width: 30px; padding-left: 8px;"><input type="checkbox" id="select-all-txns" title="Select All" /></th>
            <th id="th-type">Type</th>
            <th id="amount-header">Amount (‚Çπ)</th> 
            <th id="th-category">Category</th>
            <th id="th-description">Description</th>
            <th id="th-date">Date</th>
            <th id="th-running-balance">Balance</th> <th id="th-frequency">Frequency</th>
            <th id="th-action">Action</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
  
  <div class="ad-container">
    </div>
  
  <footer>
    <span id="footer-text">Created by Arpit Dev | Daily Finance</span>
    </footer>
</div>

<script>
  // --- Local Storage Keys ---
  const TXN_KEY = 'df_transactions';
  const CAT_KEY = 'df_categories';
  const SMART_CAT_KEY = 'df_smart_categories'; 
  const SETTINGS_KEY = 'df_settings';
  const PIN_KEY = 'df_app_pin';
  const CAT_BUDGET_KEY = 'df_cat_budgets'; 
  const LAST_BACKUP_KEY = 'df_last_backup'; 
  // REMOVED: ALL_TAGS_KEY
  // ------------------------------------

  // --- App State ---
  let transactions = [];
  let categories = [];
  let smartCategoryMap = {};
  let categoryBudgets = {}; 
  let editingTxId = null;
  let lastActivityTime = Date.now(); 
  let currentLang = 'en'; // Hardcoded to EN
  // REMOVED: allTags Set
  // --- Settings State ---
  let appSettings = {
      baseCurrency: 'INR',
      currencySymbol: '‚Çπ',
      exchangeRate: 1.0, 
      expenseGoal: 0,
      pinActive: false,
      dateFormat: 'DD/MM/YYYY', 
  };
  let currentPin = null;
  
  // --- Exchange Rates (Hardcoded, no i18n needed) ---
  const EXCHANGE_RATES = {
      'INR': { symbol: '‚Çπ', rate: 1.0, name: 'Indian Rupee' },
      'USD': { symbol: '$', rate: 83.50, name: 'US Dollar' }, 
      'EUR': { symbol: '‚Ç¨', rate: 91.00, name: 'Euro' },
      'GBP': { symbol: '¬£', rate: 107.00, name: 'British Pound' },
      'JPY': { symbol: '¬•', rate: 0.54, name: 'Japanese Yen' },
      'AUD': { symbol: 'A$', rate: 54.00, name: 'Australian Dollar' },
      'CAD': { symbol: 'C$', rate: 61.00, name: 'Canadian Dollar' }, 
      'SGD': { symbol: 'S$', rate: 63.00, name: 'Singapore Dollar' }, 
  };
  
  // --- REMOVED: I18N Dictionary (DICT) ---

  // --- I18N Utility (Simplified to use English strings) ---
  function getTranslation(key, params = {}) {
    // Only return the English string or key, as i18n is removed
    const DICT_EN = { // Minimal required strings, others are hardcoded in HTML
        'app-title': 'Daily Finance',
        'stat-net-worth-h': 'Net Worth (Overall)',
        'stat-income-h': 'Total Income (Current)',
        'stat-expense-h': 'Total Expense (Current)',
        'stat-savings-rate-h': 'Monthly Savings Rate',
        'stat-avg-expense-h': 'Avg. Daily Expense', 
        'stat-highest-expense-h': 'Highest Expense (This Mo.)', 
        'stat-goal-h': 'Monthly Expense', // MODIFIED
        'form-title': 'Record Transaction',
        'commit-btn': 'Commit Transaction',
        'cancel-edit': 'Cancel Edit',
        'category-form-title': 'Category Management',
        'add-category-btn': 'Add',
        'register-title': 'Transaction Register',
        'th-type': 'Type',
        'th-category': 'Category',
        'th-description': 'Description',
        'th-date': 'Date',
        'th-running-balance': 'Balance', 
        'th-frequency': 'Frequency',
        'th-action': 'Action',
        'chart-expense-title': 'Expense Allocation',
        'chart-income-title': 'Income Distribution',
        'chart-netflow-title': 'Monthly Net Flow (6 Mo.)',
        'export-pdf': 'Export PDF üìÑ',
        'export-csv': 'Export CSV',
        'import-json': 'Import Data üíæ',
        'clear-all': 'Clear All Data',
        'view-month': 'View This Month',
        'apply-filter': 'Apply Filters',
        'reset-filter': 'Reset Filters',
        'expense-outflow': 'Expense (Outflow)',
        'income-inflow': 'Income (Inflow)',
        'select-category': 'Select Category',
        'add-new-category': 'Add New Category',
        'search-placeholder': 'Search Description/Category', // MODIFIED
        'all-types': 'All Types',
        'all-categories': 'All Categories',
        'filter-by-tags': 'Filter by Tags',
        'footer-text': 'Created by Arpit Dev | Daily Finance',
        'lock-title': 'üîí App Locked',
        'lock-message': 'Enter your PIN to continue.',
        'loading-text': 'Loading Data...',
        'settings-title': '‚öôÔ∏è App Settings',
        'label-currency': '1. Base Currency',
        'label-date-format': '2. Date Format',
        'label-goal': '3. Monthly Expense (Current Currency)', // MODIFIED
        'label-category-budget': '4. Category Monthly Budgets', 
        'label-set-pin': '5. Set/Change PIN (4 Digits)',
        'save-settings-btn': 'Save Settings',
        'close-settings-btn': 'Close',
        'budget-left': 'Budget Left: ',
        'budget-over': 'Budget Over: ',
        'total-filtered': 'Filtered Net Flow: ',
        'modal-confirm': 'Confirm',
        'modal-cancel': 'Cancel',
        'Hello': 'Hello',
        'Good Morning': 'Good Morning',
        'Good Afternoon': 'Good Afternoon',
        'Good Evening': 'Good Evening',
        'all-years': 'All Years',
        'all-months': 'All Months',
        'Invalid currency selection.': 'Invalid currency selection.',
        'PIN must be exactly 4 digits. Leave blank to keep current or clear.': 'PIN must be exactly 4 digits. Leave blank to keep current or clear.',
        'Error': 'Error',
        'PERMANENT DATA ERASURE': 'PERMANENT DATA ERASURE',
        'Warning: This action will completely wipe all transactions and reset categories in your Local Storage. Are you certain you wish to proceed?': 'Warning: This action will completely wipe all transactions and reset categories in your Local Storage. Are you certain you wish to proceed?',
        'future-date-warning': 'Warning: This transaction is dated in the future ({date}). Are you sure you want to proceed?', 
        'backup-prompt': 'Auto-Backup: Would you like to download a backup of your data now?', 
        'Incorrect PIN. Try again.': 'Incorrect PIN. Try again.',
        'Session expired. Re-enter PIN.': 'Session expired. Re-enter PIN.',
        'View Receipt': 'View Receipt',
        'Clone Transaction': 'Clone Transaction',
        'Edit': 'Edit',
        'Delete': 'Delete',
        'Budget Amount': 'Budget Amount',
        'Goal': 'Goal',
        'Spent': 'Spent',
        'Total Income': 'Total Income',
        'Total Expense': 'Total Expense',
    };

    let translation = DICT_EN[key] || key;
    
    // Simple parameter replacement
    for (const p in params) {
        translation = translation.replace(`{${p}}`, params[p]);
    }
    return translation;
  }

  function updateLanguage() {
    // Hardcoded to English, only update dynamic elements that relied on i18n
    document.getElementById('tx-type').options[0].textContent = getTranslation('expense-outflow');
    document.getElementById('tx-type').options[1].textContent = getTranslation('income-inflow');
    document.getElementById('category').options[0].textContent = getTranslation('select-category');
    document.getElementById('new-category').placeholder = getTranslation('add-new-category');
    document.getElementById('search').placeholder = getTranslation('search-placeholder');
    document.getElementById('filter-type').options[0].textContent = getTranslation('all-types');
    document.getElementById('filter-category').options[0].textContent = getTranslation('all-categories');
    // document.getElementById('filter-tags').placeholder = getTranslation('filter-by-tags'); // REMOVED
    document.getElementById('filter-month').options[0].textContent = getTranslation('all-months');
    document.getElementById('filter-year').options[0].textContent = getTranslation('all-years');

    // Update Headings/Titles 
    document.getElementById('stat-net-worth-h').textContent = getTranslation('stat-net-worth-h');
    document.getElementById('stat-monthly-income-h').textContent = 'Monthly Income'; // NEW HARDCODED
    document.getElementById('stat-income-h').textContent = getTranslation('stat-income-h');
    document.getElementById('stat-expense-h').textContent = getTranslation('stat-expense-h');
    document.getElementById('stat-savings-rate-h').textContent = getTranslation('stat-savings-rate-h');
    document.getElementById('stat-avg-expense-h').textContent = getTranslation('stat-avg-expense-h'); 
    document.getElementById('stat-highest-expense-h').textContent = getTranslation('stat-highest-expense-h'); 
    document.getElementById('stat-goal-h').textContent = getTranslation('stat-goal-h');
    document.getElementById('form-title').textContent = getTranslation('form-title');
    document.getElementById('commit-btn').textContent = getTranslation('commit-btn');
    document.getElementById('cancel-edit').textContent = getTranslation('cancel-edit');
    document.getElementById('category-form-title').textContent = getTranslation('category-form-title');
    document.getElementById('add-category-btn').textContent = getTranslation('add-category-btn');
    document.getElementById('register-title').textContent = getTranslation('register-title');
    document.getElementById('th-type').textContent = getTranslation('th-type');
    document.getElementById('th-category').textContent = getTranslation('th-category');
    document.getElementById('th-description').textContent = getTranslation('th-description');
    // document.getElementById('th-tags').textContent = getTranslation('th-tags'); // REMOVED
    document.getElementById('th-date').textContent = getTranslation('th-date');
    document.getElementById('th-running-balance').textContent = getTranslation('th-running-balance');
    document.getElementById('th-frequency').textContent = getTranslation('th-frequency');
    document.getElementById('th-action').textContent = getTranslation('th-action');
    document.getElementById('chart-expense-title').textContent = getTranslation('chart-expense-title');
    document.getElementById('chart-income-title').textContent = getTranslation('chart-income-title');
    document.getElementById('chart-netflow-title').textContent = getTranslation('chart-netflow-title');
    document.getElementById('footer-text').textContent = getTranslation('footer-text');
    
    // Re-render UI components that use dynamic text
    updateCategoryOptions();
    updateSummary();
    renderTable();
    renderCharts();
    updateGreeting();
  }

  // --- Element References ---
  const loadingIndicator = document.getElementById('loading-indicator');
  const txForm = document.getElementById('tx-form');
  const txType = document.getElementById('tx-type');
  const amountInput = document.getElementById('amount'); 
  const categorySelect = document.getElementById('category');
  const descriptionInput = document.getElementById('description');
  const dateInput = document.getElementById('date');
  const recurringSelect = document.getElementById('recurring');
  // const tagsInput = document.getElementById('tags'); // REMOVED
  // const receiptPlaceholderInput = document.getElementById('receipt-placeholder'); // REMOVED
  const categoryForm = document.getElementById('category-form');
  const newCategoryInput = document.getElementById('new-category');
  const newCategoryTypeSelect = document.getElementById('new-category-type'); 
  const txTableBody = document.querySelector('#tx-table tbody');
  const netWorthEl = document.getElementById('net-worth');
  const monthlyIncomeStat = document.getElementById('monthly-income-stat'); // NEW
  const totalIncomeEl = document.getElementById('total-income');
  const totalExpenseEl = document.getElementById('total-expense');
  const savingsRateEl = document.getElementById('savings-rate');
  const savingsRateCard = document.getElementById('savings-rate-card');
  const avgDailyExpenseEl = document.getElementById('avg-daily-expense'); 
  const highestExpenseEl = document.getElementById('highest-expense'); 
  const highestExpenseDescEl = document.getElementById('highest-expense-desc'); 
  const filterCategory = document.getElementById('filter-category');
  const searchInput = document.getElementById('search');
  const filterType = document.getElementById('filter-type');
  // const filterTagsInput = document.getElementById('filter-tags'); // REMOVED
  const fromInput = document.getElementById('from');
  const toInput = document.getElementById('to');
  const applyFilterBtn = document.getElementById('apply-filter');
  const resetFilterBtn = document.getElementById('reset-filter');
  const viewMonthBtn = document.getElementById('view-month');
  const exportCSVBtn = document.getElementById('export-csv');
  const exportPDFBtn = document.getElementById('export-pdf');
  const importJSONBtn = document.getElementById('import-json');
  const clearAllBtn = document.getElementById('clear-all');
  const cancelEditBtn = document.getElementById('cancel-edit');
  const themeBtn = document.getElementById('theme-btn');
  const selectAllTxns = document.getElementById('select-all-txns');
  const deleteSelectedTxnsBtn = document.getElementById('delete-selected-txns');
  const settingsBtn = document.getElementById('settings-btn');
  const settingsModal = document.getElementById('settings-modal');
  const closeSettingsBtn = document.getElementById('close-settings-btn');
  const saveSettingsBtn = document.getElementById('save-settings-btn');
  const currencySelect = document.getElementById('currency-select');
  const goalInput = document.getElementById('goal-input');
  const setPinInput = document.getElementById('set-pin');
  const amountHeader = document.getElementById('amount-header');
  const headerGreeting = document.getElementById('header-greeting');
  const goalStatusText = document.getElementById('goal-status-text');
  const goalProgressBarFill = document.getElementById('goal-progress-bar-fill');
  const goalRemainingEl = document.getElementById('goal-remaining');
  const lockScreen = document.getElementById('lock-screen');
  const pinInput = document.getElementById('pin-input');
  const unlockBtn = document.getElementById('unlock-btn');
  const pinError = document.getElementById('pin-error');
  // const langSelect = document.getElementById('lang-select'); // REMOVED
  // const lastSaveTimestamp = document.getElementById('last-save-timestamp'); // REMOVED
  // const quickAddButtons = document.querySelectorAll('.quick-add-buttons button'); // REMOVED
  const budgetAlert = document.getElementById('budget-alert'); 
  const categoryBudgetList = document.getElementById('category-budget-list'); 
  const filterMonth = document.getElementById('filter-month'); 
  const filterYear = document.getElementById('filter-year'); 
  const filteredTotalEl = document.getElementById('filtered-total'); 
  const netWorthTrend = document.getElementById('net-worth-trend'); 
  const incomeTrend = document.getElementById('income-trend'); 
  const expenseTrend = document.getElementById('expense-trend'); 
  // const tagSuggestions = document.getElementById('tag-suggestions'); // REMOVED
  const minAmountInput = document.getElementById('min-amount'); 
  const maxAmountInput = document.getElementById('max-amount'); 
  const dateFormatSelect = document.getElementById('date-format-select'); 

  let expenseChart = null, incomeChart = null, monthlyBarChart = null; 
  let chartColors = {}; 

  // --- Utility Functions ---

  function convertToDisplayCurrency(amount) {
      if (appSettings.exchangeRate === 0) return amount;
      return amount / appSettings.exchangeRate; 
  }

  function formatCurrency(amount) {
    const convertedAmount = convertToDisplayCurrency(amount);
    return `${appSettings.currencySymbol}${convertedAmount.toLocaleString(currentLang.substring(0,2), { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
  }
  
  function formatDate(dateString) {
      const date = new Date(dateString);
      // Fallback to simpler date formatting as full i18n support is removed
      const year = date.getFullYear();
      let month = (date.getMonth() + 1).toString().padStart(2, '0');
      let day = date.getDate().toString().padStart(2, '0');
      
      if (appSettings.dateFormat === 'MM/DD/YYYY') {
          return `${month}/${day}/${year}`;
      }
      return `${day}/${month}/${year}`; // DD/MM/YYYY
  }

  // Time-Based Greeting (Simplified to always use English)
  function updateGreeting() {
      const hour = new Date().getHours();
      let greetingText = "Hello";
      if (hour < 12) greetingText = "Good Morning";
      else if (hour < 18) greetingText = "Good Afternoon";
      else greetingText = "Good Evening";
      
      headerGreeting.textContent = `${greetingText}, Daily Finance User!`;
  }
  
  // REMOVED: updateLastSaveTimestamp

  function normalizeDescription(desc) {
    return desc.trim().toLowerCase().replace(/[^\w\s]/g, '').replace(/\s+/g, ' ');
  }

  // --- Local Storage CRUD Helpers (Updated: Removed Tag/Lang/Backup Load/Save) ---
  
  function loadCategoryBudgets() {
      try {
          const stored = localStorage.getItem(CAT_BUDGET_KEY);
          return stored ? JSON.parse(stored) : {};
      } catch (e) {
          console.error("Error loading category budgets:", e);
          return {};
      }
  }

  function saveCategoryBudgets() {
      localStorage.setItem(CAT_BUDGET_KEY, JSON.stringify(categoryBudgets));
  }
  
  // REMOVED: loadAllTags, saveAllTags


  function loadSettings() {
      try {
          const stored = localStorage.getItem(SETTINGS_KEY);
          if (stored) {
              const loadedSettings = JSON.parse(stored);
              appSettings = { ...appSettings, ...loadedSettings };
              
              const rateData = EXCHANGE_RATES[appSettings.baseCurrency] || EXCHANGE_RATES['INR'];
              appSettings.currencySymbol = rateData.symbol;
              appSettings.exchangeRate = rateData.rate;
          }
          currentPin = localStorage.getItem(PIN_KEY);
          if (currentPin) appSettings.pinActive = true;
          
          // REMOVED: Lang load 

          amountHeader.textContent = `Amount (${appSettings.currencySymbol})`;
          dateFormatSelect.value = appSettings.dateFormat; 
      } catch (e) {
          console.error("Error loading settings:", e);
      }
  }

  function saveSettings() {
      localStorage.setItem(SETTINGS_KEY, JSON.stringify(appSettings));
      if (currentPin) {
          localStorage.setItem(PIN_KEY, currentPin);
          appSettings.pinActive = true;
      } else {
          localStorage.removeItem(PIN_KEY);
          appSettings.pinActive = false;
      }
      
      // Update UI
      amountHeader.textContent = `Amount (${appSettings.currencySymbol})`;
      renderTable();
      updateSummary();
      renderCharts();
      // REMOVED: updateLastSaveTimestamp
  }
  
  function loadTransactions() {
      try {
          const stored = localStorage.getItem(TXN_KEY);
          // MODIFIED: Removed tags field handling 
          return stored ? JSON.parse(stored).map(t => ({
              ...t,
              // Ensure tags is not present or set to an empty array for compatibility
              tags: [] 
          })) : [];
      } catch (e) {
          console.error("Error loading transactions:", e);
          return [];
      }
  }

  function saveTransactions(txns) {
    localStorage.setItem(TXN_KEY, JSON.stringify(txns));
    transactions = txns; 
    
    // REMOVED: Tag set clear/save logic

    renderTable();
    updateSummary();
    renderCharts();
    // REMOVED: updateLastSaveTimestamp
  }

  function saveCategories(cats) {
    const uniqueCats = [...new Set(cats.filter(c => typeof c === 'string' && c.trim() !== ''))];
    localStorage.setItem(CAT_KEY, JSON.stringify(uniqueCats));
    categories = uniqueCats; 
    updateCategoryOptions(); 
    // REMOVED: updateLastSaveTimestamp
  }
  
  function saveSmartCategoryMap(map) {
    localStorage.setItem(SMART_CAT_KEY, JSON.stringify(map));
    smartCategoryMap = map; 
    // REMOVED: updateLastSaveTimestamp
  }


  // --- Initialization ---

  function initUI(){
    // MODIFIED: Set Date input value and placeholder/required removed
    dateInput.value = new Date().toISOString().slice(0,10); 
    dateInput.placeholder = 'Select Date';
    // dateInput.removeAttribute('required'); // Should be removed in HTML, but kept this for safety
    
    cancelEditBtn.style.display = 'none';
    currencySelect.innerHTML = Object.keys(EXCHANGE_RATES).map(code => 
        `<option value="${code}" ${code === appSettings.baseCurrency ? 'selected' : ''}>${code} - ${EXCHANGE_RATES[code].symbol} (${EXCHANGE_RATES[code].name})</option>`
    ).join('');
    goalInput.value = appSettings.expenseGoal;
    dateFormatSelect.value = appSettings.dateFormat; 
    
    // Populate Year Filter (Current Year and 4 years back)
    const currentYear = new Date().getFullYear();
    filterYear.innerHTML = `<option value="">All Years</option>`;
    for (let i = 0; i < 5; i++) {
        const year = currentYear - i;
        filterYear.innerHTML += `<option value="${year}">${year}</option>`;
    }
    // Populate Month Filter
    const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
    filterMonth.innerHTML = `<option value="">All Months</option>`;
    filterMonth.innerHTML += `<option value="Current">This Month</option>`;
    monthNames.forEach((month, index) => {
        filterMonth.innerHTML += `<option value="${index + 1}">${month}</option>`;
    });

  }
  
  // Auto-Logout Logic (No Change)
  function resetActivityTimer() {
      lastActivityTime = Date.now();
  }

  function checkActivityAndLock() {
      if (appSettings.pinActive && (Date.now() - lastActivityTime) > (5 * 60 * 1000) && lockScreen.style.display !== 'flex') { // 5 minutes
          lockScreen.style.display = 'flex';
          document.body.style.overflow = 'hidden';
          sessionStorage.removeItem('unlocked');
          pinInput.value = '';
          pinError.textContent = 'Session expired. Re-enter PIN.';
      }
  }

  // Attach activity listeners
  ['load', 'mousemove', 'mousedown', 'keypress', 'scroll', 'touchstart'].forEach(e => {
      document.addEventListener(e, resetActivityTimer);
  });
  setInterval(checkActivityAndLock, 30000); // Check every 30 seconds

  // REMOVED: checkAutoBackup

  function initializeAppContent() {
      transactions = loadTransactions();
      categories = loadCategories();
      smartCategoryMap = loadSmartCategoryMap(); 
      categoryBudgets = loadCategoryBudgets(); 
      // REMOVED: loadAllTags
      
      initUI();
      updateLanguage(); 
      updateCategoryOptions();
      renderTable();
      updateSummary();
      renderCharts();
      // REMOVED: checkAutoBackup

      loadingIndicator.style.display = 'none';
      console.log("App initialized with Local Storage data.");
  }
  
  function checkLock() {
      if (appSettings.pinActive && sessionStorage.getItem('unlocked') !== 'true') {
          lockScreen.style.display = 'flex';
          document.body.style.overflow = 'hidden';
          return true;
      }
      return false;
  }
  
  function initializeApp() {
      loadSettings();
      if (checkLock()) {
          updateLanguage(); 
          return; 
      }
      initializeAppContent();
  }
  
  initializeApp();


  // Updates the Category dropdowns (Form and Filter)
  function updateCategoryOptions(){
    categorySelect.innerHTML = `<option value="">Select Category</option>`;
    filterCategory.innerHTML = `<option value="">All Categories</option>`;
    
    // Default categories if none exist (Fix for category issue)
    if (categories.length === 0) {
        const defaultCats = ["Salary", "Food", "Travel", "Shopping", "Bills", "Other"];
        saveCategories(defaultCats);
        // Ensure default types are set in budget map
        defaultCats.forEach(cat => {
            if (!categoryBudgets[cat]) {
                const type = cat === 'Salary' ? 'income' : 'expense';
                categoryBudgets[cat] = { budget: 0, type: type };
            }
        });
        saveCategoryBudgets();
    }
    
    const uniqueCategories = [...new Set(categories.filter(c => typeof c === 'string' && c.trim() !== ''))];

    uniqueCategories.forEach(c=>{
      // Fallback to expense if category is missing in budget map
      const type = categoryBudgets[c] && categoryBudgets[c].type ? categoryBudgets[c].type : (c === 'Salary' || c === 'Income' ? 'income' : 'expense'); 
      const opt = document.createElement('option'); opt.value = c; opt.textContent = `${c} (${type.charAt(0).toUpperCase() + type.slice(1)})`; categorySelect.appendChild(opt);
      const opt2 = document.createElement('option'); opt2.value = c; opt2.textContent = c; filterCategory.appendChild(opt2);
      
      // Update budget map if type was missing or incorrectly guessed
      if (!categoryBudgets[c] || !categoryBudgets[c].type) {
          categoryBudgets[c] = { budget: 0, type: type };
      }
    });
    
    saveCategoryBudgets(); // Save updated categoryBudgets with guessed types

    // Update Category Budget List in Settings Modal
    categoryBudgetList.innerHTML = uniqueCategories.map(cat => {
        const budgetAmount = categoryBudgets[cat] ? categoryBudgets[cat].budget : 0;
        const type = categoryBudgets[cat] ? categoryBudgets[cat].type : 'expense';
        return `
            <div style="display: flex; gap: 8px; margin-bottom: 5px; align-items: center;">
                <span style="flex: 1;">${cat} (${type.toUpperCase()})</span>
                <input type="number" data-cat="${cat}" class="category-budget-input" value="${budgetAmount}" min="0" placeholder="Budget Amount" style="width: 120px;"/>
            </div>
        `;
    }).join('');

    if (editingTxId) {
        const t = transactions.find(x=>x.id===editingTxId);
        if (t && categorySelect.querySelector(`option[value="${t.category}"]`)) {
            categorySelect.value = t.category;
        }
    }
  }

  // ===== Theme Toggle (No Change) ===== 
  themeBtn.addEventListener('click', ()=>{
    document.body.dataset.theme = document.body.dataset.theme === 'light' ? 'dark' : 'light';
    renderCharts(); // Re-render charts for theme change
  });
  
  // REMOVED: Language Toggle 

  // REMOVED: Quick Add Buttons Event Listeners
  
  // NEW: Auto-Fill from Clipboard (No Change)
  amountInput.addEventListener('paste', (e) => {
    const text = (e.clipboardData || window.clipboardData).getData('text');
    const numericValue = parseFloat(text.replace(/[^0-9.-]+/g,"")); 
    if (!isNaN(numericValue) && numericValue > 0) {
        e.preventDefault();
        amountInput.value = numericValue.toFixed(2);
    }
  });

  // ===== Budget Alert Indicator (No Change) =====
  categorySelect.addEventListener('change', () => {
    const selectedCategory = categorySelect.value;
    const isExpense = txType.value === 'expense';
    
    if (selectedCategory && isExpense && categoryBudgets[selectedCategory] && categoryBudgets[selectedCategory].budget > 0) {
        const budget = categoryBudgets[selectedCategory].budget * appSettings.exchangeRate; 
        
        const currentMonthBoundaries = getMonthBoundaries(new Date());
        const monthlyExpense = transactions
            .filter(t => t.date >= currentMonthBoundaries.start && t.date <= currentMonthBoundaries.end && t.type === 'expense' && t.category === selectedCategory)
            .reduce((sum, t) => sum + t.amount, 0);

        const remaining = budget - monthlyExpense;
        
        budgetAlert.style.display = 'block';
        budgetAlert.classList.remove('budget-good', 'budget-warning', 'budget-danger');
        
        if (remaining > 0) {
            const percentUsed = (monthlyExpense / budget) * 100;
            if (percentUsed > 80) {
                budgetAlert.classList.add('budget-warning');
            } else {
                budgetAlert.classList.add('budget-good');
            }
            budgetAlert.textContent = `Budget Left: ${formatCurrency(remaining)} (Used: ${((monthlyExpense / budget) * 100).toFixed(0)}%)`;
        } else {
            const over = Math.abs(remaining);
            budgetAlert.classList.add('budget-danger');
            budgetAlert.textContent = `Budget Over: ${formatCurrency(over)}!`;
        }

    } else {
        budgetAlert.style.display = 'none';
    }
  });
  txType.addEventListener('change', () => categorySelect.dispatchEvent(new Event('change'))); 

  // REMOVED: Tag Suggestion Logic


  // ===== Add / Edit transaction (Updated for Date value check) =====
  txForm.addEventListener('submit', (e) => {
    e.preventDefault();
    
    // MODIFIED: Check if date is set manually (since required attribute is removed)
    if (!dateInput.value) {
        alert('Please select a date for the transaction.');
        return;
    }
    
    let finalAmount = parseFloat(amountInput.value) || 0;
    finalAmount = finalAmount * appSettings.exchangeRate; 

    const tx = {
      type: txType.value, 
      amount: finalAmount, 
      category: categorySelect.value || 'Other',
      description: descriptionInput.value || '',
      date: dateInput.value, 
      recurring: recurringSelect.value || 'None',
      // REMOVED: Tags and ReceiptRef from transaction object
      createdAt: new Date().toISOString()
    };
    
    // Future Date Warning
    const today = new Date().toISOString().slice(0, 10);
    if (tx.date > today) {
        showConfirm(
            'Warning',
            `Warning: This transaction is dated in the future (${formatDate(tx.date)}). Are you sure you want to proceed?`,
            () => finalizeTransaction(tx),
            () => {} 
        );
        return; 
    }
    
    finalizeTransaction(tx);
  });
  
  function finalizeTransaction(tx) {
      
      // Update Smart Category Map
      if (tx.description.trim() !== '') {
          const normDesc = normalizeDescription(tx.description);
          if (tx.category && tx.category !== categorySelect.options[0].value) {
              const catType = categoryBudgets[tx.category] ? categoryBudgets[tx.category].type : tx.type;
              smartCategoryMap[normDesc] = { category: tx.category, type: catType };
              saveSmartCategoryMap(smartCategoryMap);
          }
      }

      let newTransactions = [...transactions];

      if(editingTxId){
          const index = newTransactions.findIndex(t => t.id === editingTxId);
          if (index !== -1) {
              newTransactions[index] = { ...newTransactions[index], ...tx };
              console.log("Transaction updated successfully.");
          }
          editingTxId = null;
      } else {
          tx.id = Date.now().toString() + Math.floor(Math.random() * 10000);
          newTransactions.push(tx);
          console.log("Transaction added successfully.");
      }

      saveTransactions(newTransactions); 
      
      txForm.reset();
      dateInput.value = new Date().toISOString().slice(0,10);
      cancelEditBtn.style.display = 'none';
      budgetAlert.style.display = 'none'; 
  }


  // ===== Add category (No Change) =====
  categoryForm.addEventListener('submit', (e)=>{
    e.preventDefault();

    const val = newCategoryInput.value.trim();
    const type = newCategoryTypeSelect.value; 

    if(val && !categories.includes(val)){
      const newCategoriesList = [...categories, val];
      saveCategories(newCategoriesList); 
      
      categoryBudgets[val] = { budget: 0, type: type };
      saveCategoryBudgets(); 
      
      newCategoryInput.value = '';
      console.log("Category added successfully.");
      updateCategoryOptions(); 
    }
  });
  
  // Smart Category Suggestion (No Change)
  descriptionInput.addEventListener('input', () => {
    const normDesc = normalizeDescription(descriptionInput.value);
    const suggestion = smartCategoryMap[normDesc];

    if (suggestion && categories.includes(suggestion.category)) {
        categorySelect.value = suggestion.category;
        txType.value = suggestion.type; 
        txType.dispatchEvent(new Event('change')); 
    } else if (!editingTxId) {
        categorySelect.value = categorySelect.options[0].value;
        txType.dispatchEvent(new Event('change'));
    }
  });

  /* ===== Filter Utility (Updated for Tags Removal) ===== */
  function getFilteredTransactions() {
    let allTransactions = [...transactions];
    const maxRecurDate = new Date();
    maxRecurDate.setMonth(maxRecurDate.getMonth() + 1); 

    transactions.forEach(t => {
        if (t.recurring === 'None') return;

        let currentDate = new Date(t.date);
        let originalDate = new Date(t.date);

        while (currentDate < maxRecurDate) {
            if (t.recurring === 'Daily') currentDate.setDate(currentDate.getDate() + 1);
            else if (t.recurring === 'Weekly') currentDate.setDate(currentDate.getDate() + 7);
            else if (t.recurring === 'Monthly') currentDate.setMonth(currentDate.getMonth() + 1);
            else break;

            if (currentDate > maxRecurDate) break;

            const newTx = {
                ...t,
                id: `R-${t.id}-${currentDate.getTime()}`,
                date: currentDate.toISOString().slice(0, 10),
                description: `(Recur. from ${originalDate.toISOString().slice(0, 10)}) ${t.description}`,
                isRecur: true,
            };
            allTransactions.push(newTx);
        }
    });

    // Apply filters
    const search = searchInput.value.trim().toLowerCase();
    const fType = filterType.value;
    const fCat = filterCategory.value;
    let from = fromInput.value;
    let to = toInput.value;
    // REMOVED: fTags
    const fMonth = filterMonth.value; 
    const fYear = filterYear.value; 
    
    const minAmount = parseFloat(minAmountInput.value) * appSettings.exchangeRate || 0; 
    const maxAmount = parseFloat(maxAmountInput.value) * appSettings.exchangeRate || Infinity; 

    // Handle Month/Year Filter
    if (fMonth || fYear) {
        const today = new Date();
        let yearToFilter = fYear || today.getFullYear();

        if (fMonth === 'Current') {
            const boundaries = getMonthBoundaries(today);
            from = boundaries.start;
            to = boundaries.end;
        } else if (fMonth) {
            const monthIndex = parseInt(fMonth) - 1;
            const start = new Date(yearToFilter, monthIndex, 1);
            const end = new Date(yearToFilter, monthIndex + 1, 0);
            from = start.toISOString().slice(0, 10);
            to = end.toISOString().slice(0, 10);
        } else if (fYear) {
            const start = new Date(yearToFilter, 0, 1);
            const end = new Date(yearToFilter, 11, 31);
            from = start.toISOString().slice(0, 10);
            to = end.toISOString().slice(0, 10);
        }
    }


    let filtered = allTransactions.filter(t=>{
      if(fType && t.type !== fType) return false;
      if(fCat && t.category !== fCat) return false;
      // MODIFIED: Removed tag search from this line
      if(search && !t.description.toLowerCase().includes(search) && !t.category.toLowerCase().includes(search)) return false;
      
      // REMOVED: Tag filter logic

      if(from && t.date < from) return false;
      if(to && t.date > to) return false;
      
      if (t.amount < minAmount) return false;
      if (t.amount > maxAmount) return false;
      
      return true;
    });

    filtered.sort((a,b)=> b.date.localeCompare(a.date) || b.createdAt.localeCompare(a.createdAt));
    return filtered;
  }
  
  // Search Highlight Utility (No Change)
  function highlightSearchTerm(text, searchTerm) {
      if (!searchTerm) return text;
      const regex = new RegExp(`(${searchTerm})`, 'gi');
      return text.replace(regex, '<span class="search-highlight">$1</span>');
  }

  /* ===== Render Table (Updated for Tags/Receipt removal) ===== */
  function renderTable(){
    const filtered = getFilteredTransactions();
    txTableBody.innerHTML = '';
    
    selectAllTxns.checked = false;
    deleteSelectedTxnsBtn.style.display = 'none';

    // Calculate Running Balance
    const sortedOriginalTxns = transactions.sort((a,b)=> a.date.localeCompare(b.date) || a.createdAt.localeCompare(b.createdAt));
    let runningBalance = 0;
    const balanceMap = {}; 

    sortedOriginalTxns.forEach(t => {
        const amount = t.type === 'income' ? t.amount : -t.amount;
        runningBalance += amount;
        balanceMap[t.id] = runningBalance;
    });

    // Update Filtered Total
    const filteredNetFlow = filtered.reduce((sum, t) => sum + (t.type === 'income' ? t.amount : -t.amount), 0);
    filteredTotalEl.textContent = `Filtered Net Flow: ${formatCurrency(filteredNetFlow)}`;
    
    if (filtered.length === 0) {
        txTableBody.innerHTML = `<tr><td colspan="9" style="text-align:center; padding: 20px; color: var(--muted);">No transactions matching current filters.</td></tr>`;
        return;
    }

    const searchTerm = searchInput.value.trim();

    filtered.forEach(t=>{
      const txId = t.id;
      const isRecur = t.isRecur; 
      const tr = document.createElement('tr');
      tr.dataset.id = txId; 
      
      // REMOVED: Tags and Receipt Link logic
      // const tagsDisplay = ''; // Tags removed
      // const receiptLink = 'N/A'; // Receipt removed
      
      const displayBalance = !isRecur && balanceMap[txId] !== undefined ? formatCurrency(balanceMap[txId]) : 'N/A';
      
      // Transaction ID Tooltip
      const dateDisplay = `<span title="TX ID: ${txId}">${formatDate(t.date)}</span>`;
      
      tr.innerHTML = `
        <td style="padding-left: 8px;">
            ${isRecur ? '‚è≥' : `<input type="checkbox" class="tx-checkbox" data-id="${txId}" />`}
        </td>
        <td><span class="badge ${t.type}">${t.type.charAt(0).toUpperCase() + t.type.slice(1)}</span></td>
        <td>${highlightSearchTerm(formatCurrency(t.amount), searchTerm)}</td>
        <td>${highlightSearchTerm(t.category, searchTerm)}</td>
        <td class="muted small">${highlightSearchTerm(t.description || 'N/A', searchTerm)}</td>
        <td>${dateDisplay}</td>
        <td>${displayBalance}</td>
        <td>${t.recurring}${isRecur ? ' (Sim.)' : ''}</td>
        <td class="actions">
            ${isRecur ? 'N/A' : `<button class="small" data-id="${txId}" onclick="onEditTx('${txId}')">Edit</button>
            <button class="small" data-id="${txId}" onclick="onDeleteTx('${txId}')">Delete</button>
            <button class="small" data-id="${txId}" onclick="onCloneTx('${txId}')" title="Clone Transaction">üìã</button>`}
        </td>
      `;
      txTableBody.appendChild(tr);
    });
    
    attachBulkActionListeners();
  }
  
  // Bulk Actions Logic (No change)
  function attachBulkActionListeners() {
      selectAllTxns.onclick = (e) => {
          const isChecked = e.target.checked;
          const checkboxes = document.querySelectorAll('.tx-checkbox');
          checkboxes.forEach(cb => cb.checked = isChecked);
          deleteSelectedTxnsBtn.style.display = isChecked ? 'inline-block' : 'none';
      };
      document.querySelectorAll('.tx-checkbox').forEach(cb => {
          cb.onchange = () => {
              const checkedCount = document.querySelectorAll('.tx-checkbox:checked').length;
              deleteSelectedTxnsBtn.style.display = checkedCount > 0 ? 'inline-block' : 'none';
              selectAllTxns.checked = checkedCount === document.querySelectorAll('.tx-checkbox').length && checkedCount > 0;
          };
      });
  }
  
  deleteSelectedTxnsBtn.addEventListener('click', handleDeleteSelected);
  function handleDeleteSelected() {
        const selectedIds = Array.from(document.querySelectorAll('.tx-checkbox:checked')).map(cb => cb.dataset.id);
        if (selectedIds.length === 0) return;
        
        showConfirm(
            'Confirm Delete',
            `Are you sure you want to delete ${selectedIds.length} selected transactions?`,
            () => {
                const newTransactions = transactions.filter(t => !selectedIds.includes(t.id));
                saveTransactions(newTransactions);
            }
        );
  }

  /* Edit action - global function for inline onclick (Updated for Tags/Receipt removal) */
  function onEditTx(id){
    const t = transactions.find(x=>x.id===id);
    if(!t) return;
    
    editingTxId = t.id;
    txType.value = t.type;
    amountInput.value = convertToDisplayCurrency(t.amount); 
    categorySelect.value = t.category;
    descriptionInput.value = t.description;
    dateInput.value = t.date;
    recurringSelect.value = t.recurring;
    // REMOVED: tagsInput.value, receiptPlaceholderInput.value
    
    window.scrollTo({top:0, behavior:'smooth'});
    cancelEditBtn.style.display = 'inline-block'; 
    categorySelect.dispatchEvent(new Event('change')); 
  };
  window.onEditTx = onEditTx; 

  /* Clone action - global function for inline onclick (Updated for Tags/Receipt removal) */
  function onCloneTx(id) {
    const t = transactions.find(x => x.id === id);
    if (!t) return;

    editingTxId = null; 
    txType.value = t.type;
    amountInput.value = convertToDisplayCurrency(t.amount);
    categorySelect.value = t.category;
    descriptionInput.value = t.description;
    dateInput.value = new Date().toISOString().slice(0, 10); 
    recurringSelect.value = 'None'; 
    // REMOVED: tagsInput.value, receiptPlaceholderInput.value

    window.scrollTo({ top: 0, behavior: 'smooth' });
    cancelEditBtn.style.display = 'none'; 
    console.log("Transaction cloned to form.");
    categorySelect.dispatchEvent(new Event('change')); 
  };
  window.onCloneTx = onCloneTx;

  /* Delete action - uses custom modal (No Change) */
  function onDeleteTx(id){
    showConfirm('Confirm Delete', 'Are you sure you want to delete this transaction?', ()=>{
      const newTransactions = transactions.filter(t=>t.id!==id);
      saveTransactions(newTransactions);
    });
  };
  window.onDeleteTx = onDeleteTx; 

  // --- Utility for getting month boundaries (No Change) ---
  function getMonthBoundaries(date) {
    const d = new Date(date);
    const start = new Date(d.getFullYear(), d.getMonth(), 1);
    const end = new Date(d.getFullYear(), d.getMonth() + 1, 0);
    return {
      start: start.toISOString().slice(0, 10),
      end: end.toISOString().slice(0, 10)
    };
  }
  
  function getPreviousMonthBoundaries(date) {
      const d = new Date(date);
      const prevMonth = new Date(d.getFullYear(), d.getMonth() - 1, 15); 
      return getMonthBoundaries(prevMonth);
  }
  
  function getTrendIndicator(current, previous, isIncome = false) {
      if (previous === 0) return { text: current > 0 ? 'NEW' : '--', class: current > 0 ? 'trend-good' : 'trend-neutral' };
      const change = current - previous;
      const percentChange = (change / previous) * 100;
      const isGood = isIncome ? change >= 0 : change <= 0;

      let className = 'trend-neutral';
      if (isGood && Math.abs(percentChange) > 5) className = 'trend-good';
      else if (!isGood && Math.abs(percentChange) > 5) className = 'trend-bad';
      
      const sign = percentChange > 0 ? '‚Üë' : (percentChange < 0 ? '‚Üì' : '--');
      const text = `${sign}${Math.abs(percentChange).toFixed(1)}%`;
      return { text, class: className };
  }


  /* ===== Summary (Updated for Monthly Income Stat) ===== */
  function updateSummary(){
    const safeTxns = transactions.filter(t => t.amount && typeof t.amount === 'number');
    
    // --- Overall Net Worth ---
    const totalIncomeINR = safeTxns.filter(t=>t.type==='income').reduce((s,t)=>s+t.amount,0);
    const totalExpenseINR = safeTxns.filter(t=>t.type==='expense').reduce((s,t)=>s+t.amount,0);
    const netWorthINR = totalIncomeINR - totalExpenseINR;

    netWorthEl.textContent = formatCurrency(netWorthINR); 
    
    // --- Current Month and Previous Month Logic (Trend Analysis) ---
    const today = new Date();
    const currentMonthBoundaries = getMonthBoundaries(today);
    const prevMonthBoundaries = getPreviousMonthBoundaries(today);
    
    const calculateData = (txns, start, end) => {
        const data = txns.filter(t => t.date >= start && t.date <= end);
        const income = data.filter(t=>t.type==='income').reduce((s,t)=>s+t.amount,0);
        const expenses = data.filter(t=>t.type==='expense'); 
        const expenseTotal = expenses.reduce((s,t)=>s+t.amount,0);
        return { income, expenses, expenseTotal };
    };
    
    // Calculate total net worth at the start of the current month
    const originalTxns = safeTxns.filter(t => !t.isRecur);
    const allOriginalTxnsBeforeCurrentMonth = originalTxns.filter(t => t.date < currentMonthBoundaries.start);
    const prevNetWorth = allOriginalTxnsBeforeCurrentMonth.reduce((sum, t) => sum + (t.type === 'income' ? t.amount : -t.amount), 0);
    
    // Net Worth Trend
    const netWorthTrendValue = netWorthINR - prevNetWorth;
    netWorthTrend.textContent = netWorthTrendValue === 0 ? '--' : (netWorthTrendValue > 0 ? '‚Üë' : '‚Üì') + formatCurrency(Math.abs(netWorthTrendValue));
    netWorthTrend.classList.remove('trend-good', 'trend-bad', 'trend-neutral');
    netWorthTrend.classList.add(netWorthTrendValue >= 0 ? 'trend-good' : 'trend-bad');
    netWorthTrend.style.display = 'inline-block';


    const currentData = calculateData(safeTxns, currentMonthBoundaries.start, currentMonthBoundaries.end);
    const prevData = calculateData(safeTxns, prevMonthBoundaries.start, prevMonthBoundaries.end);
    
    // NEW: Monthly Income Stat (overall, non-recurring)
    monthlyIncomeStat.textContent = formatCurrency(currentData.income); 
    
    totalIncomeEl.textContent = formatCurrency(currentData.income);
    totalExpenseEl.textContent = formatCurrency(currentData.expenseTotal);

    // Income Trend
    const incomeTrendIndicator = getTrendIndicator(currentData.income, prevData.income, true);
    incomeTrend.textContent = incomeTrendIndicator.text;
    incomeTrend.className = `trend-badge ${incomeTrendIndicator.class}`;
    incomeTrend.style.display = 'inline-block';

    // Expense Trend
    const expenseTrendIndicator = getTrendIndicator(currentData.expenseTotal, prevData.expenseTotal, false);
    expenseTrend.textContent = expenseTrendIndicator.text;
    expenseTrend.className = `trend-badge ${expenseTrendIndicator.class}`;
    expenseTrend.style.display = 'inline-block';


    // 1. Savings Rate Calculation
    const monthlyNetFlow = currentData.income - currentData.expenseTotal;
    let savingsRate = 0;
    if (currentData.income > 0) {
        savingsRate = (monthlyNetFlow / currentData.income) * 100;
    }
    savingsRateEl.textContent = `${savingsRate.toFixed(0)}%`;
    savingsRateCard.className = `card stat stat-status ${savingsRate >= 20 ? 'status-good' : (savingsRate >= 5 ? 'status-moderate' : 'status-poor')}`;


    // 2. Goal Tracker Logic
    const goal = appSettings.expenseGoal * appSettings.exchangeRate;
    const expenseRatio = goal > 0 ? (currentData.expenseTotal / goal) : 0;
    const percentSpent = Math.min(100, expenseRatio * 100);
    // MODIFIED: Goal status text to use simplified title
    goalStatusText.textContent = `Target: ${formatCurrency(goal)}`;
    goalRemainingEl.textContent = `${formatCurrency(currentData.expenseTotal)} / ${formatCurrency(goal)} Spent`;
    goalProgressBarFill.style.width = `${percentSpent}%`;
    
    let goalBarColor = 'var(--success)';
    if (percentSpent > 80 && percentSpent < 100) goalBarColor = 'var(--warning)';
    else if (percentSpent >= 100) goalBarColor = 'var(--danger)';
    goalProgressBarFill.style.background = goalBarColor;


    // Average Daily Expense 
    const dayOfMonth = today.getDate();
    const avgDailyExpenseINR = currentData.expenseTotal / dayOfMonth; 
    avgDailyExpenseEl.textContent = formatCurrency(avgDailyExpenseINR);

    // Highest Single Expense
    const highestTx = currentData.expenses.reduce((max, t) => (t.amount > max.amount ? t : max), { amount: 0, description: 'N/A' });
    highestExpenseEl.textContent = formatCurrency(highestTx.amount);
    highestExpenseDescEl.textContent = highestTx.description;
  }

  /* ===== Charts (No Change) ===== */
  function renderCharts(){
    const safeTxns = transactions.filter(t => t.amount && typeof t.amount === 'number' && t.amount > 0);
    
    // Define Chart.js Defaults
    Chart.defaults.font.family = 'Inter';
    Chart.defaults.color = document.body.dataset.theme === 'dark' ? 'rgba(255, 255, 255, 0.7)' : 'rgba(15, 23, 42, 0.7)';
    const primaryColor = getComputedStyle(document.documentElement).getPropertyValue('--primary');
    const successColor = getComputedStyle(document.documentElement).getPropertyValue('--success');
    const dangerColor = getComputedStyle(document.documentElement).getPropertyValue('--danger');
    const accentColor = getComputedStyle(document.documentElement).getPropertyValue('--accent');

    // Utility to get a consistent color for a category
    const getColor = (category, index) => {
        if (!chartColors[category]) {
            const colors = [primaryColor, successColor, dangerColor, accentColor, '#f59e0b', '#8b5cf6', '#ef4444', '#10b981', '#3b82f6'];
            chartColors[category] = colors[index % colors.length];
        }
        return chartColors[category];
    };


    // 1. Expense Allocation Chart (Updated for Trend Display)
    const expenseData = safeTxns.filter(t => t.type === 'expense');
    const expenseMap = expenseData.reduce((map, t) => {
        const category = t.category || 'Other';
        map[category] = (map[category] || 0) + t.amount;
        return map;
    }, {});
    
    // Calculate Previous Month's Expense for Trend
    const today = new Date();
    const prevMonthBoundaries = getPreviousMonthBoundaries(today);
    const prevMonthExpenseData = safeTxns.filter(t => t.type === 'expense' && t.date >= prevMonthBoundaries.start && t.date <= prevMonthBoundaries.end);
    const prevMonthExpenseMap = prevMonthExpenseData.reduce((map, t) => {
        const category = t.category || 'Other';
        map[category] = (map[category] || 0) + t.amount;
        return map;
    }, {});


    const expenseLabels = Object.keys(expenseMap);
    const expenseAmounts = Object.values(expenseMap).map(a => convertToDisplayCurrency(a));
    const totalExpense = expenseAmounts.reduce((s,a)=>s+a,0);
    
    // Add percentage and trend to labels
    const expenseDisplayLabels = expenseLabels.map((cat, index) => {
        const amount = expenseAmounts[index];
        const percentage = totalExpense > 0 ? (amount / totalExpense) * 100 : 0;
        
        const prevAmount = convertToDisplayCurrency(prevMonthExpenseMap[cat] || 0);
        const trend = getTrendIndicator(amount, prevAmount, false);
        
        // Add trend display
        return `${cat} ${formatCurrency(amount * appSettings.exchangeRate)} (${percentage.toFixed(0)}%) ${trend.text}`;
    });

    const expenseColors = expenseLabels.map(getColor);
    
    if(expenseChart) expenseChart.destroy();
    expenseChart = new Chart(document.getElementById('expense-chart'), {
        type: 'doughnut',
        data: {
            labels: expenseDisplayLabels,
            datasets: [{
                data: expenseAmounts,
                backgroundColor: expenseColors,
                hoverOffset: 4
            }]
        },
        options: {
            responsive: true,
            aspectRatio: 1,
            plugins: {
                legend: {
                    position: 'top',
                    labels: {
                        color: Chart.defaults.color
                    }
                },
                title: {
                    display: true,
                    text: 'Expense Allocation',
                    color: Chart.defaults.color
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.label || '';
                            if (label) {
                                label = label.split(' (')[0]; 
                            }
                            if (context.parsed !== null) {
                                label += `: ${formatCurrency(context.parsed * appSettings.exchangeRate)}`;
                            }
                            return label;
                        }
                    }
                }
            }
        }
    });

    // 2. Income Distribution Chart 
    const incomeData = safeTxns.filter(t => t.type === 'income');
    const incomeMap = incomeData.reduce((map, t) => {
        const category = t.category || 'Other';
        map[category] = (map[category] || 0) + t.amount;
        return map;
    }, {});

    const incomeLabels = Object.keys(incomeMap);
    const incomeAmounts = Object.values(incomeMap).map(a => convertToDisplayCurrency(a));
    const incomeColors = incomeLabels.map(getColor);
    
    if(incomeChart) incomeChart.destroy();
    incomeChart = new Chart(document.getElementById('income-chart'), {
        type: 'pie',
        data: {
            labels: incomeLabels,
            datasets: [{
                data: incomeAmounts,
                backgroundColor: incomeColors,
                hoverOffset: 4
            }]
        },
        options: {
            responsive: true,
            aspectRatio: 1,
            plugins: {
                legend: { position: 'top', labels: { color: Chart.defaults.color } },
                title: { display: true, text: 'Income Distribution', color: Chart.defaults.color }
            }
        }
    });
    
    // 3. Monthly Net Flow Bar Chart
    const months = [];
    const monthlyIncome = [];
    const monthlyExpense = [];

    for (let i = 5; i >= 0; i--) {
        const d = new Date();
        d.setMonth(d.getMonth() - i);
        const monthName = d.toLocaleDateString('en', { month: 'short', year: '2-digit' });
        months.push(monthName);

        const boundaries = getMonthBoundaries(d);
        const monthData = safeTxns.filter(t => t.date >= boundaries.start && t.date <= boundaries.end);

        const income = monthData.filter(t => t.type === 'income').reduce((s, t) => s + t.amount, 0);
        const expense = monthData.filter(t => t.type === 'expense').reduce((s, t) => s + t.amount, 0);

        monthlyIncome.push(convertToDisplayCurrency(income));
        monthlyExpense.push(convertToDisplayCurrency(expense));
    }

    if(monthlyBarChart) monthlyBarChart.destroy();
    monthlyBarChart = new Chart(document.getElementById('monthly-bar-chart'), {
        type: 'bar',
        data: {
            labels: months,
            datasets: [
                {
                    label: 'Total Income',
                    data: monthlyIncome,
                    backgroundColor: successColor,
                    borderColor: successColor,
                    borderWidth: 1
                },
                {
                    label: 'Total Expense',
                    data: monthlyExpense,
                    backgroundColor: dangerColor,
                    borderColor: dangerColor,
                    borderWidth: 1
                }
            ]
        },
        options: {
            responsive: true,
            aspectRatio: 1,
            plugins: {
                legend: { position: 'top', labels: { color: Chart.defaults.color } },
                title: { display: true, text: 'Monthly Net Flow (6 Mo.)', color: Chart.defaults.color },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) {
                                label += ': ';
                            }
                            if (context.parsed.y !== null) {
                                label += formatCurrency(context.parsed.y * appSettings.exchangeRate);
                            }
                            return label;
                        }
                    }
                }
            },
            scales: {
                x: { stacked: false, ticks: { color: Chart.defaults.color } },
                y: { stacked: false, ticks: { color: Chart.defaults.color } }
            }
        }
    });

  }

  /* ===== Filters & Controls (No Change) ===== */
  applyFilterBtn.addEventListener('click', ()=>{
    renderTable();
    renderCharts(); 
  });

  resetFilterBtn.addEventListener('click', ()=>{
    searchInput.value=''; filterType.value=''; filterCategory.value=''; fromInput.value=''; toInput.value=''; 
    filterMonth.value=''; filterYear.value=''; 
    minAmountInput.value=''; maxAmountInput.value=''; 
    renderTable();
    renderCharts();
  });

  // Feature: View This Month (No Change)
  viewMonthBtn.addEventListener('click', () => {
      const today = new Date();
      const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
      const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);

      fromInput.value = firstDay.toISOString().slice(0, 10);
      toInput.value = lastDay.toISOString().slice(0, 10);
      
      filterMonth.value = 'Current'; 
      filterYear.value = today.getFullYear(); 

      minAmountInput.value = ''; maxAmountInput.value = ''; 
      renderTable();
      renderCharts();
  });

  // Sync Date Range Filter with Month/Year Filters (No Change)
  filterMonth.addEventListener('change', () => {
    if(filterMonth.value || filterYear.value) {
        fromInput.value = '';
        toInput.value = '';
    }
  });
  filterYear.addEventListener('change', () => {
    if(filterMonth.value || filterYear.value) {
        fromInput.value = '';
        toInput.value = '';
    }
  });


  /* ===== Export CSV / PDF / Import (Fixed and Added) ===== */
  
  exportCSVBtn.addEventListener('click', exportToCSV);
  exportPDFBtn.addEventListener('click', exportToPDF);
  importJSONBtn.addEventListener('click', showImportModal); 

  // Helper function to create the CSV content
  function convertToCSV(data) {
    if (data.length === 0) return '';
    const header = ['ID', 'Type', 'Amount', 'Category', 'Description', 'Date', 'Frequency', 'CreatedAt'];
    
    // Adjusted: Use display currency amount for export clarity
    const rows = data.map(t => [
        `"${t.id}"`, // ID in quotes to prevent Excel conversion issues
        t.type,
        (t.amount / appSettings.exchangeRate).toFixed(2), // Convert back to display amount for export clarity
        `"${t.category}"`,
        `"${t.description.replace(/"/g, '""')}"`, // Handle quotes in description
        t.date,
        t.recurring,
        t.createdAt
    ]);
    
    return [
        header.join(','),
        ...rows.map(row => row.join(','))
    ].join('\n');
  }

  function exportToCSV() {
      const filtered = getFilteredTransactions().filter(t => !t.isRecur); // Exclude recurring simulations
      if (filtered.length === 0) {
          alert('No data to export.');
          return;
      }
      
      const csvContent = convertToCSV(filtered);
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.setAttribute('href', url);
      link.setAttribute('download', `DailyFinance_Transactions_${new Date().toISOString().slice(0, 10)}.csv`);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      alert('Data exported to CSV successfully.');
  }

  // Function to handle PDF export using jsPDF and jspdf-autotable
  function exportToPDF() {
      const filtered = getFilteredTransactions().filter(t => !t.isRecur); // Exclude recurring simulations
      if (filtered.length === 0) {
          alert('No data to export.');
          return;
      }

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ orientation: 'landscape' });

      const headers = [
          ['Type', `Amount (${appSettings.currencySymbol})`, 'Category', 'Description', 'Date', 'Frequency']
      ];
      
      // Prepare table data
      const tableData = filtered.map(t => [
          t.type.charAt(0).toUpperCase() + t.type.slice(1),
          (t.amount / appSettings.exchangeRate).toLocaleString(currentLang.substring(0,2), { minimumFractionDigits: 2, maximumFractionDigits: 2 }),
          t.category,
          t.description,
          formatDate(t.date),
          t.recurring
      ]);

      doc.setFontSize(18);
      doc.text('Daily Finance - Transaction Report', 14, 22);
      doc.setFontSize(10);
      doc.text(`Report Date: ${formatDate(new Date().toISOString().slice(0, 10))}`, 14, 28);
      doc.text(`Base Currency: ${appSettings.baseCurrency} (${appSettings.currencySymbol})`, 14, 33);
      doc.text(`Total Transactions: ${filtered.length}`, 14, 38);


      doc.autoTable({
          startY: 45,
          head: headers,
          body: tableData,
          theme: 'striped',
          headStyles: { fillColor: [11, 94, 215], textColor: 255 }, // Match primary color
          styles: { fontSize: 8 },
          columnStyles: {
              0: { cellWidth: 20 },
              1: { cellWidth: 30, halign: 'right' },
              2: { cellWidth: 30 },
              3: { cellWidth: 'auto' },
              4: { cellWidth: 25 },
              5: { cellWidth: 25 }
          }
      });

      doc.save(`DailyFinance_Report_${new Date().toISOString().slice(0, 10)}.pdf`);
      alert('Data exported to PDF successfully.');
  }

  // Function to handle JSON data import
  function showImportModal() {
      showConfirm(
          'Import Data',
          'Warning: Importing data will overwrite existing transactions. Please select a valid JSON backup file to proceed.',
          () => {
              const input = document.createElement('input');
              input.type = 'file';
              input.accept = 'application/json';
              input.onchange = (e) => {
                  const file = e.target.files[0];
                  if (!file) return;

                  const reader = new FileReader();
                  reader.onload = (event) => {
                      try {
                          const importedData = JSON.parse(event.target.result);
                          if (!Array.isArray(importedData)) throw new Error('Invalid JSON structure.');

                          
                          // Sanitize imported data to ensure all required fields are present
                          const sanitizedTxns = importedData.map(t => {
                              // Ensure amount is in the system's base currency (INR, as per the app's internal logic)
                              const amountInBase = parseFloat(t.amount) || 0;

                              return {
                                  id: t.id || Date.now().toString() + Math.floor(Math.random() * 10000),
                                  type: t.type === 'income' ? 'income' : 'expense',
                                  amount: amountInBase, 
                                  category: t.category || 'Other',
                                  description: t.description || '',
                                  date: t.date || new Date().toISOString().slice(0, 10),
                                  recurring: t.recurring || 'None',
                                  createdAt: t.createdAt || new Date().toISOString()
                              };
                          });
                          
                          // Overwrite existing transactions
                          saveTransactions(sanitizedTxns); 
                          
                          // Extract new categories from imported data
                          const importedCategories = [...new Set(sanitizedTxns.map(t => t.category).filter(c => c && !categories.includes(c)))];
                          if (importedCategories.length > 0) {
                              saveCategories([...categories, ...importedCategories]);
                          }
                          
                          alert(`Successfully imported ${sanitizedTxns.length} transactions.`);

                      } catch (error) {
                          console.error('Data import failed:', error);
                          alert(`Data import failed. Error: ${error.message}`);
                      }
                  };
                  reader.readAsText(file);
              };
              input.click();
          },
          () => {
              // Cancelled
          }
      );
  }


  /* ===== Clear all (Updated for cleanup) ===== */
  clearAllBtn.addEventListener('click', ()=>{
    showConfirm(
      'PERMANENT DATA ERASURE',
      'Warning: This action will completely wipe all transactions and reset categories in your Local Storage. Are you certain you wish to proceed?',
      ()=>{
        const defaultCategories = ["Salary", "Food", "Travel", "Shopping", "Bills", "Other"];
        
        saveTransactions([]); 
        saveCategories(defaultCategories); 
        saveSmartCategoryMap({}); 
        
        categoryBudgets = {};
        saveCategoryBudgets();
        
        localStorage.removeItem(SETTINGS_KEY);
        localStorage.removeItem(PIN_KEY);
        // REMOVED: LANG_KEY removal
        localStorage.removeItem(LAST_BACKUP_KEY); 
        
        appSettings = {
            baseCurrency: 'INR',
            currencySymbol: '‚Çπ',
            exchangeRate: 1.0, 
            expenseGoal: 0,
            pinActive: false,
            dateFormat: 'DD/MM/YYYY', 
        };
        currentPin = null;
        currentLang = 'en'; 
        // REMOVED: allTags.clear()
        
        loadSettings(); 
        initUI();
        updateLanguage(); 
        
        console.log("All data cleared successfully and reset to default.");
      }
    );
  });

  /* ===== Settings Modal Logic (Updated for Date Format and Goal Label) ===== */
  settingsBtn.addEventListener('click', () => {
      // Load current settings into the modal inputs
      currencySelect.value = appSettings.baseCurrency;
      goalInput.value = appSettings.expenseGoal;
      setPinInput.value = ''; 
      dateFormatSelect.value = appSettings.dateFormat; 
      updateCategoryOptions(); 
      settingsModal.style.display = 'flex';
  });

  closeSettingsBtn.addEventListener('click', () => {
      settingsModal.style.display = 'none';
  });

  saveSettingsBtn.addEventListener('click', () => {
      const newCurrency = currencySelect.value;
      const newGoal = parseFloat(goalInput.value) || 0;
      const newPin = setPinInput.value.trim();
      const newDateFormat = dateFormatSelect.value; 

      // 1. Currency Update
      if (EXCHANGE_RATES[newCurrency]) {
          const rateData = EXCHANGE_RATES[newCurrency];
          appSettings.baseCurrency = newCurrency;
          appSettings.currencySymbol = rateData.symbol;
          appSettings.exchangeRate = rateData.rate; 
      } else {
          showConfirm("Error", "Invalid currency selection.", ()=>{});
          return;
      }
      
      // 2. Date Format Update 
      appSettings.dateFormat = newDateFormat;

      // 3. Goal Update 
      appSettings.expenseGoal = Math.max(0, newGoal);

      // 4. Category Budgets Update 
      const budgetInputs = document.querySelectorAll('.category-budget-input');
      budgetInputs.forEach(input => {
          const cat = input.dataset.cat;
          const budget = parseFloat(input.value) || 0;
          if (categoryBudgets[cat]) {
              categoryBudgets[cat].budget = Math.max(0, budget);
          } else {
              categoryBudgets[cat] = { budget: Math.max(0, budget), type: 'expense' };
          }
      });
      saveCategoryBudgets();

      // 5. PIN Update 
      if (newPin.length > 0 && newPin.length !== 4) {
          showConfirm("Error", "PIN must be exactly 4 digits. Leave blank to keep current or clear.", ()=>{});
          return;
      } else if (newPin.length === 4) {
          currentPin = newPin;
      } else if (newPin.length === 0) {
          currentPin = null;
      }
      
      saveSettings(); 
      settingsModal.style.display = 'none';
      updateGreeting(); 
  });
  // --------------------------------------------------

  /* ===== UI Helpers (Custom Modal and Unlock Logic) ===== */
  txForm.addEventListener('change', ()=> {
    if (editingTxId) cancelEditBtn.style.display = 'inline-block';
  });
  txForm.addEventListener('input', ()=> {
    if (editingTxId) cancelEditBtn.style.display = 'inline-block';
  });
  
  // Custom Modal implementation (Hardcoded to English strings)
  function showConfirm(title, message, callback, cancelCallback) {
        document.getElementById('modal-title').textContent = title;
        document.getElementById('modal-message').textContent = message;
        document.getElementById('modal-confirm').textContent = 'Confirm';
        document.getElementById('modal-cancel').textContent = 'Cancel';
        document.getElementById('modal-overlay').style.display = 'flex';

        const confirmHandler = () => {
            document.getElementById('modal-overlay').style.display = 'none';
            callback();
            removeListeners();
        };

        const cancelHandler = () => {
            document.getElementById('modal-overlay').style.display = 'none';
            if(cancelCallback) cancelCallback();
            removeListeners();
        };

        const removeListeners = () => {
            document.getElementById('modal-confirm').removeEventListener('click', confirmHandler);
            document.getElementById('modal-cancel').removeEventListener('click', cancelHandler);
        };

        document.getElementById('modal-confirm').addEventListener('click', confirmHandler);
        document.getElementById('modal-cancel').addEventListener('click', cancelHandler);
    }
    window.showConfirm = showConfirm; 
    
    // Unlock Logic (Hardcoded to English strings)
    unlockBtn.addEventListener('click', () => {
        if (pinInput.value === currentPin) {
            lockScreen.style.display = 'none';
            document.body.style.overflow = '';
            sessionStorage.setItem('unlocked', 'true');
            pinError.textContent = '';
            if (transactions.length === 0) { 
                initializeAppContent();
            }
        } else {
            pinError.textContent = 'Incorrect PIN. Try again.';
            pinInput.value = '';
        }
    });

    pinInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            unlockBtn.click();
        }
    });
</script>

</body>
</html>
