<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="google-site-verification" content="-uZHm8AUDAmSwKTke81VW3xPlRJEYMmlE7tCSMMMEq0" />
<meta name="google-site-verification" content="IfXi5MoE4fDKJjD9_vKVC_X2q1N1Lk8KCJ0C5UFMwxQ" />
  <title>Daily Finance | Personal Budget & Expense Tracker App</title>

<meta name="description" content="Securely track your daily income and expenses. This mobile-friendly Personal Budgeting and Expense Tracker helps you achieve financial autonomy and manage your money better. Data is saved locally in your browser.">

<link rel="canonical" href="https://dailyfinances.netlify.app/" />

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

<style>
  :root{
    --primary:#0b5ed7; /* deep blue */
    --accent:#3b82f6;
    --bg-light:#f7fafc;
    --bg-dark:#0f1724;
    --card-light:#ffffff;
    --card-dark:#0b1220;
    --text-light:#0b1224;
    --text-dark:#e6eef8;
    --muted:#6b7280;
    --success:#10b981;
    --danger:#ef4444;
    --warning:#f59e0b;
    --radius:12px;
    --border-color: rgba(15, 23, 42, 0.06); /* Default light mode border */
  }
  [data-theme="dark"]{
    --bg:var(--bg-dark);
    --card:var(--card-dark);
    --text:var(--text-dark);
    --border-color: rgba(255, 255, 255, 0.1);
  }
  [data-theme="light"]{
    --bg:var(--bg-light);
    --card:var(--card-light);
    --text:var(--text-light);
  }

  *{box-sizing:border-box;font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);transition:background .25s,color .25s;}
  header{
    position:sticky; top:0; z-index:20;
    background:linear-gradient(90deg,var(--primary),var(--accent));
    color:#fff; padding:14px 18px; display:flex; align-items:center; gap:12px; box-shadow:0 6px 18px rgba(11,78,203,0.12);
    border-bottom-left-radius:0; border-bottom-right-radius:0;
  }
  .logo{
    display:flex; align-items:center; gap:10px;
    max-width: 70%;
  }
  .logo svg{width:36px;height:36px;flex:0 0 36px;border-radius:8px;background:rgba(255,255,255,0.08); padding:4px;}
  
  /* SEO Improvement 3: H1 styling for semantic correctness */
  .logo h1 { 
    margin: 0; 
    font-weight:700; 
    font-size:1.1rem; /* Match original span size */
    color: #fff; /* Ensure H1 stays white in header */
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    min-width: 0;
  }
  /* NEW VIP Feature: Greeting */
  .greeting {
      font-size: 0.9rem;
      font-weight: 500;
      color: rgba(255, 255, 255, 0.8);
      margin-left: 20px;
      /* NEW: Adjust spacing for small screens */
      display: none; 
  }
  @media(min-width: 768px) {
    .greeting {
      display: block;
    }
  }

  /* NEW: Language Selector Styling */
  .language-select {
    padding: 6px 8px;
    border-radius: 999px;
    border: none;
    background: rgba(255, 255, 255, 0.15);
    color: #fff;
    font-size: 0.85rem;
    font-weight: 500;
  }
  .language-select option {
    color: var(--text-light); /* Make options readable in all themes */
    background: var(--card-light);
  }
  /* NEW VIP Feature: Settings Icon */
  .settings-icon {
      margin-left: 10px;
      cursor: pointer;
  }
  
  .container{max-width:1100px;margin:18px auto;padding:0 14px 80px;}
  .top-actions{display:flex; gap:12px; align-items:center; justify-content:space-between; margin-bottom:14px; flex-wrap:wrap;}
  .theme-toggle, #settings-btn{background:var(--card);border:none;padding:8px 10px;border-radius:999px;cursor:pointer;box-shadow:0 3px 10px rgba(2,6,23,0.06);}
  form{background:var(--card);padding:14px;border-radius:var(--radius);box-shadow:0 4px 18px rgba(2,6,23,0.06);margin-bottom:16px;}
  .grid{display:grid; grid-template-columns:repeat(2,1fr); gap:14px;}
  @media(max-width:880px){ .grid{grid-template-columns:1fr;} .top-actions{gap:8px;}}
  .form-row{display:grid; grid-template-columns:1fr 1fr; gap:10px;}
  @media(max-width:520px){ .form-row{grid-template-columns:1fr;} }
  
  /* NEW: Input with Quick Add Buttons */
  .amount-input-group {
    display: flex;
    flex-direction: column;
    gap: 5px;
  }
  .quick-add-buttons {
      display: flex;
      gap: 5px;
  }
  .quick-add-buttons button {
      padding: 6px 8px;
      font-size: 0.8rem;
      flex: 1;
      min-width: 0;
  }
  /* NEW: Budget Alert Styling */
  #budget-alert {
    font-size: 0.85rem;
    padding: 6px 10px;
    margin-top: 5px;
    border-radius: 6px;
    display: none; /* Show only when active */
    font-weight: 500;
  }
  .budget-good { background: rgba(16, 185, 129, 0.1); color: var(--success); }
  .budget-warning { background: rgba(245, 158, 11, 0.1); color: var(--warning); }
  .budget-danger { background: rgba(239, 68, 68, 0.1); color: var(--danger); }

  input[type="text"], input[type="number"], input[type="date"], input[type="password"], select, button{
    padding:10px 12px; font-size:0.95rem; border-radius:8px; border:1px solid var(--border-color); width:100%;
    background:transparent; color:inherit;
  }
  button.primary{background:var(--primary); color:#fff; border:none; cursor:pointer; font-weight: 600;}
  button.ghost{background:transparent; border:1px solid var(--border-color); font-weight: 500;}
  .flex{display:flex; gap:8px; align-items:center; flex-wrap: wrap;} /* Added flex-wrap */
  .flex button{padding:10px 12px;}
  .card{background:var(--card); padding:14px; border-radius:var(--radius); box-shadow:0 4px 12px rgba(2,6,23,0.04);}
  .summary{display:flex; gap:12px; margin-bottom:16px; flex-wrap:wrap; justify-content: space-between;}
  .summary .stat{flex:1; min-width: 140px; text-align:left; padding:12px; border: 1px solid var(--border-color);}
  /* H3s in the summary section serve as important sub-headings */
  .stat h3{margin:0;font-size:0.9rem;color:var(--muted); text-transform: uppercase;}
  /* Original P styling */
  .stat p{margin:6px 0 0;font-weight:700;font-size:1.25rem;}

  /* --- NEW STYLING FOR TREND ANALYSIS --- */
  .stat .value-row {
    display: flex;
    justify-content: space-between;
    align-items: flex-end;
    margin: 6px 0 0;
  }
  .stat .value-row p {
    margin: 0;
    font-weight: 700;
    font-size: 1.25rem;
  }
  .trend-badge {
    font-size: 0.8rem;
    padding: 2px 6px;
    border-radius: 6px;
    font-weight: 600;
    white-space: nowrap;
    line-height: 1.2;
    margin-left: 8px; /* Added spacing */
  }
  .trend-good {
    background: rgba(16, 185, 129, 0.12);
    color: var(--success);
  }
  .trend-bad {
    background: rgba(239, 68, 68, 0.08);
    color: var(--danger);
  }
  .trend-neutral {
    background: rgba(107, 114, 128, 0.1);
    color: var(--muted);
  }
  /* -------------------------------------- */


  /* Expenses table */
  .table-wrap{overflow:auto;border-radius:10px;}
  table{width:100%;border-collapse:collapse;min-width:760px;}
  /* NEW: Min-width for table to avoid squishing on smaller phones */
  @media(max-width: 760px) {
    table{ min-width: 900px; } 
  }
  th, td{padding:12px 14px;text-align:left;border-bottom:1px solid var(--border-color);}
  th{background:var(--primary); color:#fff; position:relative; font-weight:700;}
  .badge{display:inline-block;padding:6px 10px;border-radius:999px;font-size:0.8rem; font-weight:600;}
  .badge.income{background:rgba(16,185,129,0.12); color:var(--success); border:1px solid rgba(16,185,129,0.18);}
  .badge.expense{background:rgba(239,68,68,0.08); color:var(--danger); border:1px solid rgba(239,68,68,0.12);}
  .actions button{margin-right:8px;padding:6px 10px;border-radius:6px;border:1px solid var(--border-color);cursor:pointer;background:transparent;}
  .muted{color:var(--muted);font-size:0.9rem;}
  footer{margin-top:30px;padding:14px;text-align:center;color:var(--muted); border-top: 1px solid var(--border-color);}

  /* small UI tweaks */
  .small{font-size:0.85rem;}
  .charts{display:grid; grid-template-columns:1fr 1fr; gap:14px;}
  /* Added a third column for the new Monthly Bar Chart */
  @media(min-width:1100px){ .charts{grid-template-columns:1fr 1fr 1fr;} } 
  @media(max-width:1100px){ .charts{grid-template-columns:1fr 1fr;} }
  @media(max-width:760px){ .charts{grid-template-columns:1fr;} }

  /* Custom Message Box */
  #modal-overlay, #lock-screen, #settings-modal {
    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0, 0, 0, 0.7); z-index: 1000;
    display: none;
    align-items: center; justify-content: center;
  }
  #confirm-modal, #settings-modal-content {
    background: var(--card); color: var(--text); padding: 20px;
    border-radius: var(--radius); width: 90%; max-width: 400px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
  }
  #confirm-modal h4 { margin-top: 0; color: var(--primary); }
  #modal-buttons {
    display: flex; justify-content: flex-end; gap: 10px; margin-top: 15px;
  }
  #modal-buttons button { width: auto; padding: 8px 15px; }
  #modal-buttons .confirm { background: var(--danger); color: white; border: none; }

  /* New status card styling */
  .stat-status {
    border: none !important;
    text-align: center !important;
    padding: 18px 12px;
  }
  .stat-status h3 {
    font-size: 1.0rem;
    color: var(--text);
  }
  .stat-status p {
    font-size: 1.5rem;
    font-weight: 900;
  }
  .status-good { background: var(--success); color: #fff; }
  .status-moderate { background: var(--warning); color: var(--text-dark); }
  .status-poor { background: var(--danger); color: #fff; }
  
  /* Loading Indicator */
  #loading-indicator {
    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(255, 255, 255, 0.8); z-index: 999;
    display: flex; align-items: center; justify-content: center;
    font-size: 1.2rem; font-weight: 600; color: var(--primary);
  }
  
  /* Ad-specific CSS for centering - Keeping the style but removing the ad */
  .ad-container {
    display: flex;
    justify-content: center;
    margin: 15px 0; /* Add vertical spacing */
  }

  /* REMOVED: In-App Calculator Styling */
  /* Replaced with simple input styling */
  .input-with-calc {
    display: block; /* Change to block to fill width */
    gap: 5px;
  }
  .input-with-calc input {
    width: 100%;
  }
  /* NEW VIP Feature: Goal Tracker Styling */
  .goal-progress-bar {
      height: 10px;
      background: var(--border-color);
      border-radius: 5px;
      margin-top: 6px;
      overflow: hidden;
  }
  .goal-progress {
      height: 100%;
      background: var(--primary);
      transition: width 0.5s ease-in-out;
  }
  /* NEW VIP Feature: Lock Screen Styling */
  #lock-screen {
      background: var(--bg);
      z-index: 1010;
      flex-direction: column;
  }
  #lock-screen-content {
      text-align: center;
      padding: 30px;
      border-radius: var(--radius);
      background: var(--card);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
  }
  #pin-input {
      margin-top: 15px;
      text-align: center;
      letter-spacing: 5px;
  }

  /* NEW: Search Highlight Style */
  .search-highlight {
      background-color: var(--warning);
      color: var(--text-light); /* Ensure text is visible on highlight */
      padding: 1px 3px;
      border-radius: 3px;
  }
  /* NEW: Tag Suggestions */
  #tag-suggestions {
    list-style: none;
    padding: 5px;
    margin: 0;
    border: 1px solid var(--border-color);
    border-top: none;
    border-radius: 0 0 8px 8px;
    max-height: 100px;
    overflow-y: auto;
    background: var(--card);
    position: absolute; /* Position relative to the form */
    width: 100%;
    z-index: 10;
    display: none;
  }
  #tag-suggestions li {
    padding: 5px 8px;
    cursor: pointer;
    font-size: 0.85rem;
  }
  #tag-suggestions li:hover {
    background: var(--border-color);
  }
</style>
</head>
<body data-theme="light">

<div id="lock-screen" style="display: none;">
    <div id="lock-screen-content">
        <h2 id="lock-title" style="margin-top: 0; color: var(--primary);">üîí App Locked</h2>
        <p id="lock-message">Enter your PIN to continue.</p>
        <input type="password" id="pin-input" placeholder="Enter PIN" maxlength="4" />
        <p id="pin-error" style="color: var(--danger); font-size: 0.9rem; height: 20px; margin: 5px 0 0;"></p>
        <button id="unlock-btn" class="primary" style="margin-top: 15px;">Unlock</button>
    </div>
</div>

<div id="loading-indicator" style="display: none;">
  <p id="loading-text">Loading Data...</p>
</div>

<div id="settings-modal">
    <div id="settings-modal-content">
        <h3 id="settings-title" style="margin-top: 0; color: var(--primary);">‚öôÔ∏è App Settings</h3>
        
        <label id="label-currency" for="currency-select" style="display: block; margin-top: 10px;">**1. Base Currency**</label>
        <select id="currency-select" style="margin-bottom: 15px;">
        </select>
        
        <label id="label-date-format" for="date-format-select" style="display: block;">**2. Date Format**</label>
        <select id="date-format-select" style="margin-bottom: 15px;">
            <option value="DD/MM/YYYY">DD/MM/YYYY</option>
            <option value="MM/DD/YYYY">MM/DD/YYYY</option>
        </select>

        <label id="label-goal" for="goal-input" style="display: block;">**3. Monthly Expense Goal (Current Currency)**</label>
        <input type="number" id="goal-input" placeholder="e.g., 20000" style="margin-bottom: 15px;" min="0" />

        <label id="label-category-budget" for="category-budget-list" style="display: block; margin-top: 10px;">**4. Category Monthly Budgets**</label>
        <div id="category-budget-list" style="max-height: 150px; overflow-y: auto; border: 1px solid var(--border-color); padding: 8px; border-radius: 6px; margin-bottom: 15px;">
        </div>
        
        <label id="label-set-pin" for="set-pin" style="display: block;">**5. Set/Change PIN (4 Digits)**</label>
        <input type="password" id="set-pin" placeholder="Enter new 4-digit PIN" maxlength="4" />
        <button id="save-settings-btn" class="primary" style="margin-top: 15px; width: 100%;">Save Settings</button>
        <button id="close-settings-btn" class="ghost" style="margin-top: 10px; width: 100%;">Close</button>
    </div>
</div>

<div id="modal-overlay">
  <div id="confirm-modal">
    <h4 id="modal-title">Confirm Action</h4>
    <p id="modal-message">Are you sure you want to proceed?</p>
    <div id="modal-buttons">
      <button id="modal-cancel" class="ghost">Cancel</button>
      <button id="modal-confirm" class="confirm">Confirm</button>
    </div>
  </div>
</div>

<header>
  <div class="logo" aria-hidden="true">
    <svg viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="logo">
      <rect x="2" y="2" width="44" height="44" rx="10" fill="white" opacity="0.06"/>
      <path d="M14 32c3-4 9-6 14-6" stroke="white" stroke-width="2.8" stroke-linecap="round" stroke-linejoin="round"/>
      <path d="M14 24c3-4 9-6 14-6" stroke="#CDE4FF" stroke-width="2.8" stroke-linecap="round" stroke-linejoin="round"/>
      <circle cx="36" cy="14" r="6" fill="#fff" opacity="0.12"/>
      <path d="M33.5 15.5L38.5 12.5" stroke="#fff" stroke-width="1.6" stroke-linecap="round"/>
    </svg>
    <h1 id="app-title" title="Daily Finance">Daily Finance</h1>
  </div>
  <span id="header-greeting" class="greeting"></span>

  <div style="margin-left:auto; display:flex; gap:10px; align-items:center;">
    <select id="lang-select" class="language-select" title="Select Language">
      <option value="en">EN</option>
      <option value="hi">HI</option>
      <option value="de">DE</option>
      <option value="es">ES</option>
    </select>
    <button class="theme-toggle settings-icon" id="settings-btn" title="Settings">‚öôÔ∏è</button>
    <button class="theme-toggle" id="theme-btn" title="Toggle theme">üåì</button>
  </div>
</header>

<div class="container">

  <div class="top-actions">
    <p id="data-storage-info" class="muted small" style="margin:0;">
      Financial autonomy at your fingertips. Data is stored securely in your browser's Local Storage.
    </p>
    <p id="filtered-total" class="muted small" style="margin:0; font-weight: 600;"></p>
    <div class="flex">
      <button id="delete-selected-txns" class="ghost small" style="display: none;">Delete Selected</button>
      <button id="export-pdf" class="ghost small">Export PDF üìÑ</button>
      <button id="export-csv" class="ghost small">Export CSV</button>
      <button id="import-json" class="ghost small">Import Data üíæ</button>
      <button id="clear-all" class="ghost small">Clear All Data</button>
    </div>
  </div>

  <div class="ad-container">
    </div>
  
  <div class="summary">
    <div class="card stat">
      <h3 id="stat-net-worth-h">Net Worth (Overall)</h3>
      <div class="value-row">
        <p id="net-worth">‚Çπ0.00</p>
        <span id="net-worth-trend" class="trend-badge trend-neutral" style="display: none;">--</span>
      </div>
    </div>
    <div class="card stat">
      <h3 id="stat-income-h">Total Income (Current)</h3>
      <div class="value-row">
        <p id="total-income">‚Çπ0.00</p>
        <span id="income-trend" class="trend-badge trend-neutral" style="display: none;">--</span>
        </div>
    </div>
    <div class="card stat">
      <h3 id="stat-expense-h">Total Expense (Current)</h3>
      <div class="value-row">
        <p id="total-expense">‚Çπ0.00</p>
        <span id="expense-trend" class="trend-badge trend-neutral" style="display: none;">--</span>
        </div>
    </div>
    <div id="savings-rate-card" class="card stat stat-status status-good">
      <h3 id="stat-savings-rate-h">Monthly Savings Rate</h3>
      <p id="savings-rate">0%</p>
    </div>
    <div id="avg-daily-expense-card" class="card stat">
      <h3 id="stat-avg-expense-h">Avg. Daily Expense</h3>
      <p id="avg-daily-expense">‚Çπ0.00</p>
    </div>
    <div id="highest-expense-card" class="card stat">
      <h3 id="stat-highest-expense-h">Highest Expense (This Mo.)</h3>
      <p id="highest-expense">‚Çπ0.00</p>
      <p class="muted small" id="highest-expense-desc"></p>
    </div>
    <div id="monthly-goal-card" class="card stat" style="min-width: 200px;">
        <h3 id="stat-goal-h">Monthly Expense Goal</h3>
        <p id="goal-status-text">Goal: N/A</p>
        <div class="goal-progress-bar">
            <div id="goal-progress-bar-fill" class="goal-progress" style="width: 0%; background: var(--warning);"></div>
        </div>
        <p class="muted small" id="goal-remaining" style="margin: 4px 0 0;">‚Çπ0.00 / ‚Çπ0.00 Spent</p>
    </div>
  </div>

  <div class="grid">
    <form id="tx-form" class="card" autocomplete="off">
      <h3 id="form-title" style="margin-top:0;">Record Transaction</h3>
      <div class="form-row">
        <select id="tx-type" required>
          <option value="expense">Expense (Outflow)</option>
          <option value="income">Income (Inflow)</option>
        </select>
        <div class="amount-input-group">
          <input id="amount" type="number" placeholder="Amount (in base currency)" step="0.01" required /> 
          <div class="quick-add-buttons">
            <button type="button" class="ghost small" data-add="100">+100</button>
            <button type="button" class="ghost small" data-add="500">+500</button>
            <button type="button" class="ghost small" data-add="1000">+1k</button>
            <button type="button" class="ghost small" data-add="5000">+5k</button>
          </div>
        </div>
      </div>

      <div class="form-row" style="margin-top:8px;">
        <select id="category" required>
          <option value="">Select Category</option>
        </select>
        <input id="description" type="text" placeholder="Description / Vendor" />
      </div>

      <p id="budget-alert" class="budget-good">Budget Left: 100%</p>

      <div class="form-row" style="margin-top:8px;">
        <input id="date" type="date" required />
        <select id="recurring">
          <option value="None">Frequency: None</option>
          <option value="Daily">Daily</option>
          <option value="Weekly">Weekly</option>
          <option value="Monthly">Monthly</option>
        </select>
      </div>
      
      <div class="form-row" style="margin-top:8px; position: relative;">
          <input id="tags" type="text" placeholder="Tags (e.g., #urgent, #travel)" />
          <ul id="tag-suggestions" style="position: absolute; top: 100%; left: 0; right: 0;"></ul>
          <input id="receipt-placeholder" type="text" placeholder="Receipt Photo Ref. / Link" />
      </div>

      <div style="margin-top:10px; display:flex; gap:8px;">
        <button id="commit-btn" type="submit" class="primary">Commit Transaction</button>
        <button type="button" id="cancel-edit" class="ghost">Cancel Edit</button>
      </div>
    </form>
    
    <div>
      
      <form id="category-form" class="card small">
        <h3 id="category-form-title" style="margin:0 0 8px 0;">Category Management</h3>
        <div style="display:flex; gap:8px; margin-bottom: 8px;">
          <input id="new-category" type="text" placeholder="Add New Category" required />
          <select id="new-category-type" style="width: auto; flex: 0 0 100px;">
            <option value="expense">Expense</option>
            <option value="income">Income</option>
          </select>
          <button id="add-category-btn" type="submit" class="primary" style="flex: 0 0 50px;">Add</button>
        </div>
        <p id="category-list-info" class="muted small" style="margin: 0;"></p>
      </form>

      <div class="ad-container">
         </div>
      
      <div class="charts" style="margin-top:14px;">
        <div class="card">
          <h3 id="chart-expense-title" style="margin-top:0;">Expense Allocation</h3>
          <canvas id="expense-chart"></canvas>
        </div>
        <div class="card">
          <h3 id="chart-income-title" style="margin-top:0;">Income Distribution</h3>
          <canvas id="income-chart"></canvas>
        </div>
        <div class="card">
            <h3 id="chart-netflow-title" style="margin-top:0;">Monthly Net Flow (6 Mo.)</h3>
            <canvas id="monthly-bar-chart"></canvas>
        </div>
      </div>
      
      </div>
  </div>
  
  <div class="card" style="margin-top:8px;">
    <h3 id="register-title" style="margin-top:0;">Transaction Register</h3>
    <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:10px;">
      <input id="search" type="text" placeholder="Search Description/Category/Tags" style="min-width:180px;" />
      <select id="filter-month" style="width: auto; min-width: 100px;">
        <option value="">All Months</option>
        <option value="Current">This Month</option>
      </select>
      <select id="filter-year" style="width: auto; min-width: 100px;">
        <option value="">All Years</option>
      </select>
      <select id="filter-type">
        <option value="">All Types</option>
        <option value="income">Income</option>
        <option value="expense">Expense</option>
      </select>
      <select id="filter-category">
        <option value="">All Categories</option>
      </select>
      <input id="filter-tags" type="text" placeholder="Filter by Tags" style="min-width:120px;" />
      <input id="from" type="date" title="Filter from start date" style="width: 130px; min-width: 0;" />
      <input id="to" type="date" title="Filter to end date" style="width: 130px; min-width: 0;" />
      <input id="min-amount" type="number" placeholder="Min Amount" min="0" step="0.01" style="width: 100px; min-width: 0;" />
      <input id="max-amount" type="number" placeholder="Max Amount" min="0" step="0.01" style="width: 100px; min-width: 0;" />
      <button id="view-month" class="primary">View This Month</button>
      <button id="apply-filter" class="ghost">Apply Filters</button>
      <button id="reset-filter" class="ghost">Reset Filters</button>
    </div>

    <div class="table-wrap card" style="padding:0;">
      <table id="tx-table" role="grid" aria-label="Transactions register">
        <thead>
          <tr>
            <th style="width: 30px; padding-left: 8px;"><input type="checkbox" id="select-all-txns" title="Select All" /></th>
            <th id="th-type">Type</th>
            <th id="amount-header">Amount (‚Çπ)</th> 
            <th id="th-category">Category</th>
            <th id="th-description">Description</th>
            <th id="th-tags">Tags</th> 
            <th id="th-date">Date</th>
            <th id="th-running-balance">Balance</th> <th id="th-frequency">Frequency</th>
            <th id="th-action">Action</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
  
  <div class="ad-container">
    </div>
  
  <footer>
    <span id="footer-text">Created by Arpit Dev | Daily Finance</span>
    <span id="last-save-timestamp" class="muted small" style="margin-left: 15px;">Last Save: N/A</span>
  </footer>
</div>

<script>
  // --- Local Storage Keys ---
  const TXN_KEY = 'df_transactions';
  const CAT_KEY = 'df_categories';
  const SMART_CAT_KEY = 'df_smart_categories'; 
  const SETTINGS_KEY = 'df_settings';
  const PIN_KEY = 'df_app_pin';
  const CAT_BUDGET_KEY = 'df_cat_budgets'; 
  const LANG_KEY = 'df_language';
  const LAST_BACKUP_KEY = 'df_last_backup'; // NEW: For auto-backup feature
  const ALL_TAGS_KEY = 'df_all_tags'; // NEW: For tag auto-complete
  // ------------------------------------

  // --- App State ---
  let transactions = [];
  let categories = [];
  let smartCategoryMap = {};
  let categoryBudgets = {}; 
  let editingTxId = null;
  let lastActivityTime = Date.now(); 
  let currentLang = 'en'; 
  let allTags = new Set(); // NEW: Set to store all used tags
  // --- NEW VIP Feature: Settings State ---
  let appSettings = {
      baseCurrency: 'INR',
      currencySymbol: '‚Çπ',
      exchangeRate: 1.0, 
      expenseGoal: 0,
      pinActive: false,
      dateFormat: 'DD/MM/YYYY', // NEW: Date Format Setting
  };
  let currentPin = null;
  
  // --- Exchange Rates (Updated with more realistic rates) ---
  const EXCHANGE_RATES = {
      'INR': { symbol: '‚Çπ', rate: 1.0, name: 'Indian Rupee' },
      'USD': { symbol: '$', rate: 83.50, name: 'US Dollar' }, 
      'EUR': { symbol: '‚Ç¨', rate: 91.00, name: 'Euro' },
      'GBP': { symbol: '¬£', rate: 107.00, name: 'British Pound' },
      'JPY': { symbol: '¬•', rate: 0.54, name: 'Japanese Yen' },
      'AUD': { symbol: 'A$', rate: 54.00, name: 'Australian Dollar' },
      'CAD': { symbol: 'C$', rate: 61.00, name: 'Canadian Dollar' }, // NEW
      'SGD': { symbol: 'S$', rate: 63.00, name: 'Singapore Dollar' }, // NEW
  };
  
  // --- I18N Dictionary (Updated for German and Spanish) ---
  const DICT = {
    en: {
        'app-title': 'Daily Finance',
        'data-storage-info': "Financial autonomy at your fingertips. Data is stored securely in your browser's Local Storage.",
        'stat-net-worth-h': 'Net Worth (Overall)',
        'stat-income-h': 'Total Income (Current)',
        'stat-expense-h': 'Total Expense (Current)',
        'stat-savings-rate-h': 'Monthly Savings Rate',
        'stat-avg-expense-h': 'Avg. Daily Expense', 
        'stat-highest-expense-h': 'Highest Expense (This Mo.)', 
        'stat-goal-h': 'Monthly Expense Goal',
        'form-title': 'Record Transaction',
        'commit-btn': 'Commit Transaction',
        'cancel-edit': 'Cancel Edit',
        'category-form-title': 'Category Management',
        'add-category-btn': 'Add',
        'register-title': 'Transaction Register',
        'th-type': 'Type',
        'th-category': 'Category',
        'th-description': 'Description',
        'th-tags': 'Tags',
        'th-date': 'Date',
        'th-running-balance': 'Balance', 
        'th-frequency': 'Frequency',
        'th-action': 'Action',
        'chart-expense-title': 'Expense Allocation',
        'chart-income-title': 'Income Distribution',
        'chart-netflow-title': 'Monthly Net Flow (6 Mo.)',
        'export-pdf': 'Export PDF üìÑ',
        'export-csv': 'Export CSV',
        'import-json': 'Import Data üíæ',
        'clear-all': 'Clear All Data',
        'view-month': 'View This Month',
        'apply-filter': 'Apply Filters',
        'reset-filter': 'Reset Filters',
        'expense-outflow': 'Expense (Outflow)',
        'income-inflow': 'Income (Inflow)',
        'select-category': 'Select Category',
        'add-new-category': 'Add New Category',
        'search-placeholder': 'Search Description/Category/Tags',
        'all-types': 'All Types',
        'all-categories': 'All Categories',
        'filter-by-tags': 'Filter by Tags',
        'footer-text': 'Created by Arpit Dev | Daily Finance',
        'lock-title': 'üîí App Locked',
        'lock-message': 'Enter your PIN to continue.',
        'loading-text': 'Loading Data...',
        'settings-title': '‚öôÔ∏è App Settings',
        'label-currency': '1. Base Currency',
        'label-date-format': '2. Date Format', // NEW
        'label-goal': '3. Monthly Expense Goal (Current Currency)',
        'label-category-budget': '4. Category Monthly Budgets', 
        'label-set-pin': '5. Set/Change PIN (4 Digits)',
        'save-settings-btn': 'Save Settings',
        'close-settings-btn': 'Close',
        'budget-left': 'Budget Left: ',
        'budget-over': 'Budget Over: ',
        'total-filtered': 'Filtered Net Flow: ',
        'modal-confirm': 'Confirm',
        'modal-cancel': 'Cancel',
        'Hello': 'Hello',
        'Good Morning': 'Good Morning',
        'Good Afternoon': 'Good Afternoon',
        'Good Evening': 'Good Evening',
        'all-years': 'All Years',
        'all-months': 'All Months',
        'Invalid currency selection.': 'Invalid currency selection.',
        'PIN must be exactly 4 digits. Leave blank to keep current or clear.': 'PIN must be exactly 4 digits. Leave blank to keep current or clear.',
        'Error': 'Error',
        'PERMANENT DATA ERASURE': 'PERMANENT DATA ERASURE',
        'Warning: This action will completely wipe all transactions and reset categories in your Local Storage. Are you certain you wish to proceed?': 'Warning: This action will completely wipe all transactions and reset categories in your Local Storage. Are you certain you wish to proceed?',
        // 'daily-limit-warning': 'Daily Transaction Limit Reached: You have recorded {count} transactions today. Please review your spending!', // REMOVED
        'future-date-warning': 'Warning: This transaction is dated in the future ({date}). Are you sure you want to proceed?', // NEW
        'backup-prompt': 'Auto-Backup: Would you like to download a backup of your data now?', // NEW
    },
    hi: {
        'app-title': '‡§°‡•á‡§≤‡•Ä ‡§´‡§æ‡§á‡§®‡•á‡§Ç‡§∏',
        'data-storage-info': '‡§Ü‡§™‡§ï‡•Ä ‡§â‡§Ç‡§ó‡§≤‡§ø‡§Ø‡•ã‡§Ç ‡§™‡§∞ ‡§µ‡§ø‡§§‡•ç‡§§‡•Ä‡§Ø ‡§∏‡•ç‡§µ‡§æ‡§Ø‡§§‡•ç‡§§‡§§‡§æ‡•§ ‡§°‡•á‡§ü‡§æ ‡§Ü‡§™‡§ï‡•á ‡§¨‡•ç‡§∞‡§æ‡§â‡§ú‡§º‡§∞ ‡§ï‡•á ‡§≤‡•ã‡§ï‡§≤ ‡§∏‡•ç‡§ü‡•ã‡§∞‡•á‡§ú ‡§Æ‡•á‡§Ç ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§ø‡§§ ‡§∞‡•Ç‡§™ ‡§∏‡•á ‡§∏‡•á‡§µ‡•ç‡§° ‡§π‡•à‡•§',
        'stat-net-worth-h': '‡§ï‡•Å‡§≤ ‡§∏‡§Ç‡§™‡§§‡•ç‡§§‡§ø (Overall)',
        'stat-income-h': '‡§ï‡•Å‡§≤ ‡§Ü‡§Ø (Current)',
        'stat-expense-h': '‡§ï‡•Å‡§≤ ‡§ñ‡§∞‡•ç‡§ö (Current)',
        'stat-savings-rate-h': '‡§Æ‡§æ‡§∏‡§ø‡§ï ‡§¨‡§ö‡§§ ‡§¶‡§∞',
        'stat-avg-expense-h': '‡§î‡§∏‡§§ ‡§¶‡•à‡§®‡§ø‡§ï ‡§ñ‡§∞‡•ç‡§ö', 
        'stat-highest-expense-h': '‡§∏‡§¨‡§∏‡•á ‡§¨‡§°‡§º‡§æ ‡§ñ‡§∞‡•ç‡§ö (‡§á‡§∏ ‡§Æ‡§π‡•Ä‡§®‡•á)', 
        'stat-goal-h': '‡§Æ‡§æ‡§∏‡§ø‡§ï ‡§ñ‡§∞‡•ç‡§ö ‡§≤‡§ï‡•ç‡§∑‡•ç‡§Ø',
        'form-title': '‡§≤‡•á‡§®-‡§¶‡•á‡§® ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç',
        'commit-btn': '‡§≤‡•á‡§®-‡§¶‡•á‡§® ‡§ú‡§Æ‡§æ ‡§ï‡§∞‡•á‡§Ç',
        'cancel-edit': '‡§è‡§°‡§ø‡§ü ‡§∞‡§¶‡•ç‡§¶ ‡§ï‡§∞‡•á‡§Ç',
        'category-form-title': '‡§∂‡•ç‡§∞‡•á‡§£‡•Ä ‡§™‡•ç‡§∞‡§¨‡§Ç‡§ß‡§®',
        'add-category-btn': '‡§ú‡•ã‡§°‡§º‡•á‡§Ç',
        'register-title': '‡§≤‡•á‡§®-‡§¶‡•á‡§® ‡§∞‡§ú‡§ø‡§∏‡•ç‡§ü‡§∞',
        'th-type': '‡§™‡•ç‡§∞‡§ï‡§æ‡§∞',
        'th-category': '‡§∂‡•ç‡§∞‡•á‡§£‡•Ä',
        'th-description': '‡§µ‡§ø‡§µ‡§∞‡§£',
        'th-tags': '‡§ü‡•à‡§ó‡•ç‡§∏',
        'th-date': '‡§¶‡§ø‡§®‡§æ‡§Ç‡§ï',
        'th-running-balance': '‡§∂‡•á‡§∑ ‡§∞‡§æ‡§∂‡§ø', 
        'th-frequency': '‡§Ü‡§µ‡•É‡§§‡•ç‡§§‡§ø',
        'th-action': '‡§ï‡§æ‡§∞‡•ç‡§∞‡§µ‡§æ‡§à',
        'chart-expense-title': '‡§ñ‡§∞‡•ç‡§ö ‡§ï‡§æ ‡§Ü‡§µ‡§Ç‡§ü‡§®',
        'chart-income-title': '‡§Ü‡§Ø ‡§ï‡§æ ‡§µ‡§ø‡§§‡§∞‡§£',
        'chart-netflow-title': '‡§Æ‡§æ‡§∏‡§ø‡§ï ‡§®‡•á‡§ü ‡§´‡•ç‡§≤‡•ã (6 ‡§Æ‡§π‡•Ä‡§®‡•á)',
        'export-pdf': 'PDF ‡§®‡§ø‡§∞‡•ç‡§Ø‡§æ‡§§ ‡§ï‡§∞‡•á‡§Ç üìÑ',
        'export-csv': 'CSV ‡§®‡§ø‡§∞‡•ç‡§Ø‡§æ‡§§ ‡§ï‡§∞‡•á‡§Ç',
        'import-json': '‡§°‡•á‡§ü‡§æ ‡§Ü‡§Ø‡§æ‡§§ ‡§ï‡§∞‡•á‡§Ç üíæ',
        'clear-all': '‡§∏‡§æ‡§∞‡§æ ‡§°‡•á‡§ü‡§æ ‡§Æ‡§ø‡§ü‡§æ ‡§¶‡•á‡§Ç',
        'view-month': '‡§Ø‡§π ‡§Æ‡§π‡•Ä‡§®‡§æ ‡§¶‡•á‡§ñ‡•á‡§Ç',
        'apply-filter': '‡§´‡§º‡§ø‡§≤‡•ç‡§ü‡§∞ ‡§≤‡§æ‡§ó‡•Ç ‡§ï‡§∞‡•á‡§Ç',
        'reset-filter': '‡§´‡§º‡§ø‡§≤‡•ç‡§ü‡§∞ ‡§∞‡•Ä‡§∏‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç',
        'expense-outflow': '‡§ñ‡§∞‡•ç‡§ö (‡§¨‡§π‡§ø‡§∞‡•ç‡§µ‡§æ‡§π)',
        'income-inflow': '‡§Ü‡§Ø (‡§Ö‡§Ç‡§§‡§∞‡•ç‡§µ‡§æ‡§π)',
        'select-category': '‡§∂‡•ç‡§∞‡•á‡§£‡•Ä ‡§ö‡•Å‡§®‡•á‡§Ç',
        'add-new-category': '‡§®‡§à ‡§∂‡•ç‡§∞‡•á‡§£‡•Ä ‡§ú‡•ã‡§°‡§º‡•á‡§Ç',
        'search-placeholder': '‡§µ‡§ø‡§µ‡§∞‡§£/‡§∂‡•ç‡§∞‡•á‡§£‡•Ä/‡§ü‡•à‡§ó‡•ç‡§∏ ‡§ñ‡•ã‡§ú‡•á‡§Ç',
        'all-types': '‡§∏‡§≠‡•Ä ‡§™‡•ç‡§∞‡§ï‡§æ‡§∞',
        'all-categories': '‡§∏‡§≠‡•Ä ‡§∂‡•ç‡§∞‡•á‡§£‡§ø‡§Ø‡§æ‡§Ç',
        'filter-by-tags': '‡§ü‡•à‡§ó‡•ç‡§∏ ‡§¶‡•ç‡§µ‡§æ‡§∞‡§æ ‡§´‡§º‡§ø‡§≤‡•ç‡§ü‡§∞ ‡§ï‡§∞‡•á‡§Ç',
        'footer-text': '‡§Ö‡§∞‡•ç‡§™‡§ø‡§§ ‡§¶‡•á‡§µ ‡§¶‡•ç‡§µ‡§æ‡§∞‡§æ ‡§®‡§ø‡§∞‡•ç‡§Æ‡§ø‡§§ | ‡§°‡•á‡§≤‡•Ä ‡§´‡§æ‡§á‡§®‡•á‡§Ç‡§∏',
        'lock-title': 'üîí ‡§ê‡§™ ‡§≤‡•â‡§ï ‡§π‡•à',
        'lock-message': '‡§ú‡§æ‡§∞‡•Ä ‡§∞‡§ñ‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§Ö‡§™‡§®‡§æ ‡§™‡§ø‡§® ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç‡•§',
        'loading-text': '‡§°‡•á‡§ü‡§æ ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...',
        'settings-title': '‚öôÔ∏è ‡§ê‡§™ ‡§∏‡•á‡§ü‡§ø‡§Ç‡§ó‡•ç‡§∏',
        'label-currency': '1. ‡§Ü‡§ß‡§æ‡§∞ ‡§Æ‡•Å‡§¶‡•ç‡§∞‡§æ',
        'label-date-format': '2. ‡§¶‡§ø‡§®‡§æ‡§Ç‡§ï ‡§™‡•ç‡§∞‡§æ‡§∞‡•Ç‡§™', // NEW
        'label-goal': '3. ‡§Æ‡§æ‡§∏‡§ø‡§ï ‡§ñ‡§∞‡•ç‡§ö ‡§≤‡§ï‡•ç‡§∑‡•ç‡§Ø (‡§µ‡§∞‡•ç‡§§‡§Æ‡§æ‡§® ‡§Æ‡•Å‡§¶‡•ç‡§∞‡§æ)',
        'label-category-budget': '4. ‡§∂‡•ç‡§∞‡•á‡§£‡•Ä ‡§Æ‡§æ‡§∏‡§ø‡§ï ‡§¨‡§ú‡§ü', 
        'label-set-pin': '5. ‡§™‡§ø‡§® ‡§∏‡•á‡§ü/‡§¨‡§¶‡§≤‡•á‡§Ç (4 ‡§Ö‡§Ç‡§ï)',
        'save-settings-btn': '‡§∏‡•á‡§ü‡§ø‡§Ç‡§ó‡•ç‡§∏ ‡§∏‡•á‡§µ ‡§ï‡§∞‡•á‡§Ç',
        'close-settings-btn': '‡§¨‡§Ç‡§¶ ‡§ï‡§∞‡•á‡§Ç',
        'budget-left': '‡§¨‡§ú‡§ü ‡§∂‡•á‡§∑: ',
        'budget-over': '‡§¨‡§ú‡§ü ‡§Ö‡§ß‡§ø‡§ï: ',
        'total-filtered': '‡§´‡§º‡§ø‡§≤‡•ç‡§ü‡§∞‡•ç‡§° ‡§®‡•á‡§ü ‡§´‡•ç‡§≤‡•ã: ',
        'modal-confirm': '‡§™‡•Å‡§∑‡•ç‡§ü‡§ø ‡§ï‡§∞‡•á‡§Ç',
        'modal-cancel': '‡§∞‡§¶‡•ç‡§¶ ‡§ï‡§∞‡•á‡§Ç',
        'Hello': '‡§®‡§Æ‡§∏‡•ç‡§§‡•á',
        'Good Morning': '‡§∏‡•Å‡§™‡•ç‡§∞‡§≠‡§æ‡§§',
        'Good Afternoon': '‡§∂‡•Å‡§≠ ‡§¶‡•ã‡§™‡§π‡§∞',
        'Good Evening': '‡§∂‡•Å‡§≠ ‡§∏‡§Ç‡§ß‡•ç‡§Ø‡§æ',
        'all-years': '‡§∏‡§≠‡•Ä ‡§µ‡§∞‡•ç‡§∑',
        'all-months': '‡§∏‡§≠‡•Ä ‡§Æ‡§π‡•Ä‡§®‡•á',
        'Invalid currency selection.': '‡§Ö‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§Æ‡•Å‡§¶‡•ç‡§∞‡§æ ‡§ö‡§Ø‡§®‡•§',
        'PIN must be exactly 4 digits. Leave blank to keep current or clear.': '‡§™‡§ø‡§® ‡§†‡•Ä‡§ï 4 ‡§Ö‡§Ç‡§ï‡•ã‡§Ç ‡§ï‡§æ ‡§π‡•ã‡§®‡§æ ‡§ö‡§æ‡§π‡§ø‡§è‡•§ ‡§µ‡§∞‡•ç‡§§‡§Æ‡§æ‡§® ‡§ï‡•ã ‡§∞‡§ñ‡§®‡•á ‡§Ø‡§æ ‡§∏‡§æ‡§´‡§º ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ñ‡§æ‡§≤‡•Ä ‡§õ‡•ã‡§°‡§º ‡§¶‡•á‡§Ç‡•§',
        'Error': '‡§§‡•ç‡§∞‡•Å‡§ü‡§ø',
        'PERMANENT DATA ERASURE': '‡§∏‡•ç‡§•‡§æ‡§Ø‡•Ä ‡§°‡•á‡§ü‡§æ ‡§Æ‡§ø‡§ü‡§æ‡§®‡§æ',
        'Warning: This action will completely wipe all transactions and reset categories in your Local Storage. Are you certain you wish to proceed?': '‡§ö‡•á‡§§‡§æ‡§µ‡§®‡•Ä: ‡§Ø‡§π ‡§ï‡§æ‡§∞‡•ç‡§∞‡§µ‡§æ‡§à ‡§Ü‡§™‡§ï‡•á ‡§≤‡•ã‡§ï‡§≤ ‡§∏‡•ç‡§ü‡•ã‡§∞‡•á‡§ú ‡§Æ‡•á‡§Ç ‡§∏‡§≠‡•Ä ‡§≤‡•á‡§®-‡§¶‡•á‡§® ‡§ï‡•ã ‡§™‡•Ç‡§∞‡•Ä ‡§§‡§∞‡§π ‡§∏‡•á ‡§Æ‡§ø‡§ü‡§æ ‡§¶‡•á‡§ó‡•Ä ‡§î‡§∞ ‡§∂‡•ç‡§∞‡•á‡§£‡§ø‡§Ø‡•ã‡§Ç ‡§ï‡•ã ‡§∞‡•Ä‡§∏‡•á‡§ü ‡§ï‡§∞ ‡§¶‡•á‡§ó‡•Ä‡•§ ‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§Ü‡§ó‡•á ‡§¨‡§¢‡§º‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç?',
        // 'daily-limit-warning': '‡§¶‡•à‡§®‡§ø‡§ï ‡§≤‡•á‡§®-‡§¶‡•á‡§® ‡§∏‡•Ä‡§Æ‡§æ ‡§§‡§ï ‡§™‡§π‡•Å‡§Å‡§ö‡•á: ‡§Ü‡§™‡§®‡•á ‡§Ü‡§ú {count} ‡§≤‡•á‡§®-‡§¶‡•á‡§® ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§ø‡§è ‡§π‡•à‡§Ç‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§Ö‡§™‡§®‡•á ‡§ñ‡§∞‡•ç‡§ö ‡§ï‡•Ä ‡§∏‡§Æ‡•Ä‡§ï‡•ç‡§∑‡§æ ‡§ï‡§∞‡•á‡§Ç!', // REMOVED
        'future-date-warning': '‡§ö‡•á‡§§‡§æ‡§µ‡§®‡•Ä: ‡§Ø‡§π ‡§≤‡•á‡§®-‡§¶‡•á‡§® ‡§≠‡§µ‡§ø‡§∑‡•ç‡§Ø ‡§ï‡•Ä ‡§§‡§ø‡§•‡§ø ({date}) ‡§ï‡§æ ‡§π‡•à‡•§ ‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§Ü‡§ó‡•á ‡§¨‡§¢‡§º‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç?', // NEW
        'backup-prompt': '‡§ë‡§ü‡•ã-‡§¨‡•à‡§ï‡§Ö‡§™: ‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§Ö‡§≠‡•Ä ‡§Ö‡§™‡§®‡•á ‡§°‡•á‡§ü‡§æ ‡§ï‡§æ ‡§¨‡•à‡§ï‡§Ö‡§™ ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡§æ ‡§ö‡§æ‡§π‡•á‡§Ç‡§ó‡•á?', // NEW
    },
    // NEW LANGUAGE: German (DE)
    de: {
        'app-title': 'T√§gliche Finanzen',
        'data-storage-info': "Finanzielle Autonomie an Ihren Fingerspitzen. Daten werden sicher im lokalen Speicher Ihres Browsers gespeichert.",
        'stat-net-worth-h': 'Gesamtverm√∂gen',
        'stat-income-h': 'Gesamteinnahmen (Aktuell)',
        'stat-expense-h': 'Gesamtausgaben (Aktuell)',
        'stat-savings-rate-h': 'Monatliche Sparquote',
        'stat-avg-expense-h': 'Durchschn. t√§gliche Ausgabe', 
        'stat-highest-expense-h': 'H√∂chste Ausgabe (Dieser Mo.)', 
        'stat-goal-h': 'Monatliches Ausgabenziel',
        'form-title': 'Transaktion aufzeichnen',
        'commit-btn': 'Transaktion festschreiben',
        'cancel-edit': 'Bearbeitung abbrechen',
        'category-form-title': 'Kategorienverwaltung',
        'add-category-btn': 'Hinzuf√ºgen',
        'register-title': 'Transaktionsregister',
        'th-type': 'Typ',
        'th-category': 'Kategorie',
        'th-description': 'Beschreibung',
        'th-tags': 'Tags',
        'th-date': 'Datum',
        'th-running-balance': 'Kontostand', 
        'th-frequency': 'H√§ufigkeit',
        'th-action': 'Aktion',
        'chart-expense-title': 'Ausgabenverteilung',
        'chart-income-title': 'Einnahmenverteilung',
        'chart-netflow-title': 'Monatlicher Nettofluss (6 Mo.)',
        'export-pdf': 'PDF exportieren üìÑ',
        'export-csv': 'CSV exportieren',
        'import-json': 'Daten importieren üíæ',
        'clear-all': 'Alle Daten l√∂schen',
        'view-month': 'Diesen Monat anzeigen',
        'apply-filter': 'Filter anwenden',
        'reset-filter': 'Filter zur√ºcksetzen',
        'expense-outflow': 'Ausgabe (Abfluss)',
        'income-inflow': 'Einnahme (Zufluss)',
        'select-category': 'Kategorie ausw√§hlen',
        'add-new-category': 'Neue Kategorie hinzuf√ºgen',
        'search-placeholder': 'Beschreibung/Kategorie/Tags suchen',
        'all-types': 'Alle Typen',
        'all-categories': 'Alle Kategorien',
        'filter-by-tags': 'Nach Tags filtern',
        'footer-text': 'Erstellt von Arpit Dev | Daily Finance',
        'lock-title': 'üîí App Gesperrt',
        'lock-message': 'Geben Sie Ihre PIN ein, um fortzufahren.',
        'loading-text': 'Daten werden geladen...',
        'settings-title': '‚öôÔ∏è App-Einstellungen',
        'label-currency': '1. Basisw√§hrung',
        'label-date-format': '2. Datumsformat', // NEW
        'label-goal': '3. Monatliches Ausgabenziel (Aktuelle W√§hrung)',
        'label-category-budget': '4. Kategorie Monatsbudgets', 
        'label-set-pin': '5. PIN festlegen/√§ndern (4 Ziffern)',
        'save-settings-btn': 'Einstellungen speichern',
        'close-settings-btn': 'Schlie√üen',
        'budget-left': 'Budget √ºbrig: ',
        'budget-over': 'Budget √ºberschritten: ',
        'total-filtered': 'Gefilterter Nettofluss: ',
        'modal-confirm': 'Best√§tigen',
        'modal-cancel': 'Abbrechen',
        'Hello': 'Hallo',
        'Good Morning': 'Guten Morgen',
        'Good Afternoon': 'Guten Tag',
        'Good Evening': 'Guten Abend',
        'all-years': 'Alle Jahre',
        'all-months': 'Alle Monate',
        'Invalid currency selection.': 'Ung√ºltige W√§hrungsauswahl.',
        'PIN must be exactly 4 digits. Leave blank to keep current or clear.': 'PIN muss genau 4 Ziffern lang sein. Leer lassen, um aktuell zu behalten oder zu l√∂schen.',
        'Error': 'Fehler',
        'PERMANENT DATA ERASURE': 'DAUERHAFTE DATENL√ñSCHUNG',
        'Warning: This action will completely wipe all transactions and reset categories in your Local Storage. Are you certain you wish to proceed?': 'Warnung: Diese Aktion l√∂scht alle Transaktionen und setzt Kategorien in Ihrem lokalen Speicher vollst√§ndig zur√ºck. Sind Sie sicher, dass Sie fortfahren m√∂chten?',
        // 'daily-limit-warning': 'T√§gliches Transaktionslimit erreicht: Sie haben heute {count} Transaktionen erfasst. Bitte √ºberpr√ºfen Sie Ihre Ausgaben!', // REMOVED
        'future-date-warning': 'Warnung: Diese Transaktion ist f√ºr ein zuk√ºnftiges Datum ({date}). Sind Sie sicher, dass Sie fortfahren m√∂chten?', // NEW
        'backup-prompt': 'Auto-Backup: M√∂chten Sie jetzt eine Sicherung Ihrer Daten herunterladen?', // NEW
    },
    // NEW LANGUAGE: Spanish (ES)
    es: {
        'app-title': 'Finanzas Diarias',
        'data-storage-info': "Autonom√≠a financiera a su alcance. Los datos se guardan de forma segura en el Almacenamiento Local de su navegador.",
        'stat-net-worth-h': 'Patrimonio Neto (Total)',
        'stat-income-h': 'Ingreso Total (Actual)',
        'stat-expense-h': 'Gasto Total (Actual)',
        'stat-savings-rate-h': 'Tasa de Ahorro Mensual',
        'stat-avg-expense-h': 'Gasto Diario Promedio', 
        'stat-highest-expense-h': 'Gasto M√°ximo (Este Mes)', 
        'stat-goal-h': 'Objetivo de Gasto Mensual',
        'form-title': 'Registrar Transacci√≥n',
        'commit-btn': 'Confirmar Transacci√≥n',
        'cancel-edit': 'Cancelar Edici√≥n',
        'category-form-title': 'Gesti√≥n de Categor√≠as',
        'add-category-btn': 'Agregar',
        'register-title': 'Registro de Transacciones',
        'th-type': 'Tipo',
        'th-category': 'Categor√≠a',
        'th-description': 'Descripci√≥n',
        'th-tags': 'Etiquetas',
        'th-date': 'Fecha',
        'th-running-balance': 'Saldo', 
        'th-frequency': 'Frecuencia',
        'th-action': 'Acci√≥n',
        'chart-expense-title': 'Asignaci√≥n de Gastos',
        'chart-income-title': 'Distribuci√≥n de Ingresos',
        'chart-netflow-title': 'Flujo Neto Mensual (6 Meses)',
        'export-pdf': 'Exportar PDF üìÑ',
        'export-csv': 'Exportar CSV',
        'import-json': 'Importar Datos üíæ',
        'clear-all': 'Borrar Todos los Datos',
        'view-month': 'Ver Este Mes',
        'apply-filter': 'Aplicar Filtros',
        'reset-filter': 'Restablecer Filtros',
        'expense-outflow': 'Gasto (Salida)',
        'income-inflow': 'Ingreso (Entrada)',
        'select-category': 'Seleccionar Categor√≠a',
        'add-new-category': 'A√±adir Nueva Categor√≠a',
        'search-placeholder': 'Buscar Descripci√≥n/Categor√≠a/Etiquetas',
        'all-types': 'Todos los Tipos',
        'all-categories': 'Todas las Categor√≠as',
        'filter-by-tags': 'Filtrar por Etiquetas',
        'footer-text': 'Creado por Arpit Dev | Finanzas Diarias',
        'lock-title': 'üîí Aplicaci√≥n Bloqueada',
        'lock-message': 'Ingrese su PIN para continuar.',
        'loading-text': 'Cargando Datos...',
        'settings-title': '‚öôÔ∏è Configuraci√≥n de la Aplicaci√≥n',
        'label-currency': '1. Moneda Base',
        'label-date-format': '2. Formato de Fecha', // NEW
        'label-goal': '3. Objetivo de Gasto Mensual (Moneda Actual)',
        'label-category-budget': '4. Presupuestos Mensuales por Categor√≠a', 
        'label-set-pin': '5. Establecer/Cambiar PIN (4 D√≠gitos)',
        'save-settings-btn': 'Guardar Configuraci√≥n',
        'close-settings-btn': 'Cerrar',
        'budget-left': 'Presupuesto restante: ',
        'budget-over': 'Presupuesto superado: ',
        'total-filtered': 'Flujo Neto Filtrado: ',
        'modal-confirm': 'Confirmar',
        'modal-cancel': 'Cancelar',
        'Hello': 'Hola',
        'Good Morning': 'Buenos D√≠as',
        'Good Afternoon': 'Buenas Tardes',
        'Good Evening': 'Buenas Noches',
        'all-years': 'Todos los A√±os',
        'all-months': 'Todos los Meses',
        'Invalid currency selection.': 'Selecci√≥n de moneda no v√°lida.',
        'PIN must be exactly 4 digits. Leave blank to keep current or clear.': 'El PIN debe ser exactamente de 4 d√≠gitos. Deje en blanco para mantener el actual o borrar.',
        'Error': 'Error',
        'PERMANENT DATA ERASURE': 'BORRADO PERMANENTE DE DATOS',
        'Warning: This action will completely wipe all transactions and reset categories in your Local Storage. Are you certain you wish to proceed?': 'Advertencia: Esta acci√≥n borrar√° completamente todas las transacciones y restablecer√° las categor√≠as en su Almacenamiento Local. ¬øEst√° seguro de que desea continuar?',
        // 'daily-limit-warning': 'L√≠mite de Transacciones Diarias Alcanzado: Ha registrado {count} transacciones hoy. ¬°Por favor, revise sus gastos!', // REMOVED
        'future-date-warning': 'Advertencia: Esta transacci√≥n est√° fechada en el futuro ({date}). ¬øEst√° seguro de que desea continuar?', // NEW
        'backup-prompt': 'Copia de Seguridad Autom√°tica: ¬øLe gustar√≠a descargar una copia de seguridad de sus datos ahora?', // NEW
    }
  };

  // --- I18N Utility ---
  function getTranslation(key, params = {}) {
    let translation = DICT[currentLang][key] || DICT['en'][key] || key;
    
    // Simple parameter replacement (NEW)
    for (const p in params) {
        translation = translation.replace(`{${p}}`, params[p]);
    }
    return translation;
  }

  function updateLanguage() {
    // Update all elements with an ID that matches a key in the dictionary
    Object.keys(DICT.en).forEach(key => {
        const el = document.getElementById(key);
        if (el) {
            if (el.tagName === 'INPUT' && (el.placeholder !== undefined)) { // Use !== undefined for placeholder check
                el.placeholder = getTranslation(key);
            } else if (el.tagName === 'BUTTON' || el.tagName === 'H1' || el.tagName === 'H3' || el.tagName === 'P' || el.tagName === 'SPAN' || el.tagName === 'LABEL') {
                el.textContent = getTranslation(key);
            }
        }
    });

    // Update specific hardcoded texts/titles
    document.getElementById('tx-type').options[0].textContent = getTranslation('expense-outflow');
    document.getElementById('tx-type').options[1].textContent = getTranslation('income-inflow');
    document.getElementById('category').options[0].textContent = getTranslation('select-category');
    document.getElementById('new-category').placeholder = getTranslation('add-new-category');
    document.getElementById('search').placeholder = getTranslation('search-placeholder');
    document.getElementById('filter-type').options[0].textContent = getTranslation('all-types');
    document.getElementById('filter-category').options[0].textContent = getTranslation('all-categories');
    document.getElementById('filter-tags').placeholder = getTranslation('filter-by-tags');
    document.getElementById('filter-month').options[0].textContent = getTranslation('all-months');
    document.getElementById('filter-year').options[0].textContent = getTranslation('all-years');
    
    // Re-render UI components that use dynamic text
    updateCategoryOptions();
    updateSummary();
    renderTable();
    renderCharts();
    updateGreeting();
  }

  // --- Element References (and new ones) ---
  const loadingIndicator = document.getElementById('loading-indicator');
  const txForm = document.getElementById('tx-form');
  const txType = document.getElementById('tx-type');
  const amountInput = document.getElementById('amount'); 
  const categorySelect = document.getElementById('category');
  const descriptionInput = document.getElementById('description');
  const dateInput = document.getElementById('date');
  const recurringSelect = document.getElementById('recurring');
  const tagsInput = document.getElementById('tags');
  const receiptPlaceholderInput = document.getElementById('receipt-placeholder');
  const categoryForm = document.getElementById('category-form');
  const newCategoryInput = document.getElementById('new-category');
  const newCategoryTypeSelect = document.getElementById('new-category-type'); 
  const txTableBody = document.querySelector('#tx-table tbody');
  const netWorthEl = document.getElementById('net-worth');
  const totalIncomeEl = document.getElementById('total-income');
  const totalExpenseEl = document.getElementById('total-expense');
  const savingsRateEl = document.getElementById('savings-rate');
  const savingsRateCard = document.getElementById('savings-rate-card');
  const avgDailyExpenseEl = document.getElementById('avg-daily-expense'); 
  const highestExpenseEl = document.getElementById('highest-expense'); 
  const highestExpenseDescEl = document.getElementById('highest-expense-desc'); 
  const filterCategory = document.getElementById('filter-category');
  const searchInput = document.getElementById('search');
  const filterType = document.getElementById('filter-type');
  const filterTagsInput = document.getElementById('filter-tags');
  const fromInput = document.getElementById('from');
  const toInput = document.getElementById('to');
  const applyFilterBtn = document.getElementById('apply-filter');
  const resetFilterBtn = document.getElementById('reset-filter');
  const viewMonthBtn = document.getElementById('view-month');
  const exportCSVBtn = document.getElementById('export-csv');
  const exportPDFBtn = document.getElementById('export-pdf');
  const importJSONBtn = document.getElementById('import-json');
  const clearAllBtn = document.getElementById('clear-all');
  const cancelEditBtn = document.getElementById('cancel-edit');
  const themeBtn = document.getElementById('theme-btn');
  const selectAllTxns = document.getElementById('select-all-txns');
  const deleteSelectedTxnsBtn = document.getElementById('delete-selected-txns');
  const settingsBtn = document.getElementById('settings-btn');
  const settingsModal = document.getElementById('settings-modal');
  const closeSettingsBtn = document.getElementById('close-settings-btn');
  const saveSettingsBtn = document.getElementById('save-settings-btn');
  const currencySelect = document.getElementById('currency-select');
  const goalInput = document.getElementById('goal-input');
  const setPinInput = document.getElementById('set-pin');
  const amountHeader = document.getElementById('amount-header');
  const headerGreeting = document.getElementById('header-greeting');
  const goalStatusText = document.getElementById('goal-status-text');
  const goalProgressBarFill = document.getElementById('goal-progress-bar-fill');
  const goalRemainingEl = document.getElementById('goal-remaining');
  const lockScreen = document.getElementById('lock-screen');
  const pinInput = document.getElementById('pin-input');
  const unlockBtn = document.getElementById('unlock-btn');
  const pinError = document.getElementById('pin-error');
  const langSelect = document.getElementById('lang-select'); 
  const lastSaveTimestamp = document.getElementById('last-save-timestamp'); 
  const quickAddButtons = document.querySelectorAll('.quick-add-buttons button'); 
  const budgetAlert = document.getElementById('budget-alert'); 
  const categoryBudgetList = document.getElementById('category-budget-list'); 
  const filterMonth = document.getElementById('filter-month'); 
  const filterYear = document.getElementById('filter-year'); 
  const filteredTotalEl = document.getElementById('filtered-total'); 
  const netWorthTrend = document.getElementById('net-worth-trend'); // NEW: Net Worth Trend
  const incomeTrend = document.getElementById('income-trend'); // Existing, added ID
  const expenseTrend = document.getElementById('expense-trend'); // Existing, added ID
  const tagSuggestions = document.getElementById('tag-suggestions'); // NEW: Tag Suggestions
  const minAmountInput = document.getElementById('min-amount'); // NEW: Filter by Amount
  const maxAmountInput = document.getElementById('max-amount'); // NEW: Filter by Amount
  const dateFormatSelect = document.getElementById('date-format-select'); // NEW: Date Format

  let expenseChart = null, incomeChart = null, monthlyBarChart = null; 
  let chartColors = {}; // To store category colors globally for consistency

  // --- Utility Functions ---

  function convertToDisplayCurrency(amount) {
      if (appSettings.exchangeRate === 0) return amount;
      return amount / appSettings.exchangeRate; 
  }

  function formatCurrency(amount) {
    const convertedAmount = convertToDisplayCurrency(amount);
    return `${appSettings.currencySymbol}${convertedAmount.toLocaleString(currentLang.substring(0,2), { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
  }
  
  // NEW: Date Format Utility (Feature 15)
  function formatDate(dateString) {
      const date = new Date(dateString);
      const year = date.getFullYear();
      // Use toLocaleDateString for international format display
      if (appSettings.dateFormat === 'MM/DD/YYYY') {
          return date.toLocaleDateString(currentLang, { year: 'numeric', month: '2-digit', day: '2-digit' });
      }
      return date.toLocaleDateString(currentLang, { year: 'numeric', month: '2-digit', day: '2-digit' });
  }

  // NEW VIP Feature: Time-Based Greeting
  function updateGreeting() {
      const hour = new Date().getHours();
      let greetingKey = "Hello";
      if (hour < 12) greetingKey = "Good Morning";
      else if (hour < 18) greetingKey = "Good Afternoon";
      else greetingKey = "Good Evening";
      
      const greetingText = getTranslation(greetingKey);
      headerGreeting.textContent = `${greetingText}, Daily Finance User!`;
  }
  
  // NEW: Update Last Save Timestamp
  function updateLastSaveTimestamp() {
    const now = new Date();
    lastSaveTimestamp.textContent = `Last Save: ${now.toLocaleTimeString(currentLang)}`;
  }

  function normalizeDescription(desc) {
    return desc.trim().toLowerCase().replace(/[^\w\s]/g, '').replace(/\s+/g, ' ');
  }

  // --- Local Storage CRUD Helpers (Updated for Tags and Save Timestamp) ---
  
  function loadCategoryBudgets() {
      // ... (Existing) ...
      try {
          const stored = localStorage.getItem(CAT_BUDGET_KEY);
          return stored ? JSON.parse(stored) : {};
      } catch (e) {
          console.error("Error loading category budgets:", e);
          return {};
      }
  }

  function saveCategoryBudgets() {
      localStorage.setItem(CAT_BUDGET_KEY, JSON.stringify(categoryBudgets));
  }
  
  function loadAllTags() {
      try {
          const stored = localStorage.getItem(ALL_TAGS_KEY);
          return stored ? new Set(JSON.parse(stored)) : new Set();
      } catch (e) {
          console.error("Error loading tags:", e);
          return new Set();
      }
  }

  function saveAllTags() {
      localStorage.setItem(ALL_TAGS_KEY, JSON.stringify(Array.from(allTags)));
  }


  function loadSettings() {
      // ... (Existing Settings Load Logic) ...
      try {
          const stored = localStorage.getItem(SETTINGS_KEY);
          if (stored) {
              const loadedSettings = JSON.parse(stored);
              appSettings = { ...appSettings, ...loadedSettings };
              
              const rateData = EXCHANGE_RATES[appSettings.baseCurrency] || EXCHANGE_RATES['INR'];
              appSettings.currencySymbol = rateData.symbol;
              appSettings.exchangeRate = rateData.rate;
          }
          currentPin = localStorage.getItem(PIN_KEY);
          if (currentPin) appSettings.pinActive = true;
          
          currentLang = localStorage.getItem(LANG_KEY) || 'en'; // Load language
          langSelect.value = currentLang; // Set selector 

          amountHeader.textContent = `Amount (${appSettings.currencySymbol})`;
          dateFormatSelect.value = appSettings.dateFormat; // NEW: Set date format
      } catch (e) {
          console.error("Error loading settings:", e);
      }
  }

  function saveSettings() {
      localStorage.setItem(SETTINGS_KEY, JSON.stringify(appSettings));
      if (currentPin) {
          localStorage.setItem(PIN_KEY, currentPin);
          appSettings.pinActive = true;
      } else {
          localStorage.removeItem(PIN_KEY);
          appSettings.pinActive = false;
      }
      
      // Update UI
      amountHeader.textContent = `Amount (${appSettings.currencySymbol})`;
      renderTable();
      updateSummary();
      renderCharts();
      updateLastSaveTimestamp(); 
  }
  
  function loadTransactions() {
      try {
          const stored = localStorage.getItem(TXN_KEY);
          return stored ? JSON.parse(stored).map(t => ({
              ...t,
              // Ensure tags are always an array
              tags: Array.isArray(t.tags) ? t.tags : (t.tags || '').split(',').map(tag => tag.trim()).filter(tag => tag !== '') 
          })) : [];
      } catch (e) {
          console.error("Error loading transactions:", e);
          return [];
      }
  }

  function saveTransactions(txns) {
    localStorage.setItem(TXN_KEY, JSON.stringify(txns));
    transactions = txns; 
    
    // Update All Tags Set (NEW)
    allTags.clear();
    txns.forEach(t => t.tags.forEach(tag => allTags.add(tag)));
    saveAllTags();

    renderTable();
    updateSummary();
    renderCharts();
    updateLastSaveTimestamp(); 
  }

  function saveCategories(cats) {
    // ... (Existing) ...
    const uniqueCats = [...new Set(cats.filter(c => typeof c === 'string' && c.trim() !== ''))];
    localStorage.setItem(CAT_KEY, JSON.stringify(uniqueCats));
    categories = uniqueCats; 
    updateCategoryOptions(); 
    updateLastSaveTimestamp(); 
  }
  
  function saveSmartCategoryMap(map) {
    // ... (Existing) ...
    localStorage.setItem(SMART_CAT_KEY, JSON.stringify(map));
    smartCategoryMap = map; 
    updateLastSaveTimestamp(); 
  }


  // --- Initialization (Updated) ---

  function initUI(){
    // ... (Existing initUI) ...
    dateInput.value = new Date().toISOString().slice(0,10);
    cancelEditBtn.style.display = 'none';
    currencySelect.innerHTML = Object.keys(EXCHANGE_RATES).map(code => 
        `<option value="${code}" ${code === appSettings.baseCurrency ? 'selected' : ''}>${code} - ${EXCHANGE_RATES[code].symbol} (${EXCHANGE_RATES[code].name})</option>`
    ).join('');
    goalInput.value = appSettings.expenseGoal;
    dateFormatSelect.value = appSettings.dateFormat; // NEW: Set Date Format Select
    
    // Populate Year Filter (Current Year and 4 years back)
    const currentYear = new Date().getFullYear();
    filterYear.innerHTML = `<option value="">${getTranslation('all-years')}</option>`;
    for (let i = 0; i < 5; i++) {
        const year = currentYear - i;
        filterYear.innerHTML += `<option value="${year}">${year}</option>`;
    }
    // Populate Month Filter
    const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
    filterMonth.innerHTML = `<option value="">${getTranslation('all-months')}</option>`;
    filterMonth.innerHTML += `<option value="Current">${getTranslation('view-month')}</option>`;
    monthNames.forEach((month, index) => {
        filterMonth.innerHTML += `<option value="${index + 1}">${month}</option>`;
    });

  }
  
  // NEW: Auto-Logout Logic (Existing logic kept, no change needed)
  function resetActivityTimer() {
      lastActivityTime = Date.now();
  }

  function checkActivityAndLock() {
      if (appSettings.pinActive && (Date.now() - lastActivityTime) > (5 * 60 * 1000) && lockScreen.style.display !== 'flex') { // 5 minutes
          lockScreen.style.display = 'flex';
          document.body.style.overflow = 'hidden';
          sessionStorage.removeItem('unlocked');
          pinInput.value = '';
          pinError.textContent = getTranslation('Session expired. Re-enter PIN.');
      }
  }

  // Attach activity listeners
  ['load', 'mousemove', 'mousedown', 'keypress', 'scroll', 'touchstart'].forEach(e => {
      document.addEventListener(e, resetActivityTimer);
  });
  setInterval(checkActivityAndLock, 30000); // Check every 30 seconds

  // NEW: Auto-Backup Check (Feature 12)
  function checkAutoBackup() {
      const lastBackup = localStorage.getItem(LAST_BACKUP_KEY);
      const now = Date.now();
      const oneDay = 24 * 60 * 60 * 1000;
      
      if (!lastBackup || (now - parseInt(lastBackup)) > oneDay) {
          // Prompt for backup
          showConfirm(getTranslation('Auto-Backup'), getTranslation('backup-prompt'), () => {
              exportJSON();
              localStorage.setItem(LAST_BACKUP_KEY, now.toString());
          }, () => {
              // User canceled, reset timer for another day
              localStorage.setItem(LAST_BACKUP_KEY, now.toString()); 
          });
      }
  }

  function initializeAppContent() {
      transactions = loadTransactions();
      categories = loadCategories();
      smartCategoryMap = loadSmartCategoryMap(); 
      categoryBudgets = loadCategoryBudgets(); 
      allTags = loadAllTags(); // NEW: Load All Tags
      
      initUI();
      updateLanguage(); 
      updateCategoryOptions();
      renderTable();
      updateSummary();
      renderCharts();
      checkAutoBackup(); // NEW: Check backup on load

      loadingIndicator.style.display = 'none';
      console.log("App initialized with Local Storage data.");
  }
  
  // ... (Existing checkLock logic) ...
  function checkLock() {
      if (appSettings.pinActive && sessionStorage.getItem('unlocked') !== 'true') {
          lockScreen.style.display = 'flex';
          document.body.style.overflow = 'hidden';
          return true;
      }
      return false;
  }
  
  function initializeApp() {
      loadSettings();
      if (checkLock()) {
          // If locked, content will be loaded upon unlock
          // Ensure language is set for lock screen text
          updateLanguage(); 
          return; 
      }
      initializeAppContent();
  }
  
  initializeApp();


  // Updates the Category dropdowns (Form and Filter)
  function updateCategoryOptions(){
    categorySelect.innerHTML = `<option value="">${getTranslation('select-category')}</option>`;
    filterCategory.innerHTML = `<option value="">${getTranslation('all-categories')}</option>`;
    
    const uniqueCategories = [...new Set(categories.filter(c => typeof c === 'string' && c.trim() !== ''))];

    uniqueCategories.forEach(c=>{
      const type = categoryBudgets[c] && categoryBudgets[c].type ? categoryBudgets[c].type : 'expense'; 
      const opt = document.createElement('option'); opt.value = c; opt.textContent = `${c} (${type.toUpperCase()})`; categorySelect.appendChild(opt);
      const opt2 = document.createElement('option'); opt2.value = c; opt2.textContent = c; filterCategory.appendChild(opt2);
    });
    
    // Update Category Budget List in Settings Modal
    categoryBudgetList.innerHTML = uniqueCategories.map(cat => {
        const budgetAmount = categoryBudgets[cat] ? categoryBudgets[cat].budget : 0;
        const type = categoryBudgets[cat] ? categoryBudgets[cat].type : 'expense';
        return `
            <div style="display: flex; gap: 8px; margin-bottom: 5px; align-items: center;">
                <span style="flex: 1;">${cat} (${type.toUpperCase()})</span>
                <input type="number" data-cat="${cat}" class="category-budget-input" value="${budgetAmount}" min="0" placeholder="${getTranslation('Budget Amount')}" style="width: 120px;"/>
            </div>
        `;
    }).join('');

    if (editingTxId) {
        const t = transactions.find(x=>x.id===editingTxId);
        if (t && categorySelect.querySelector(`option[value="${t.category}"]`)) {
            categorySelect.value = t.category;
        }
    }
  }

  // ===== Theme Toggle (No Change) ===== 
  themeBtn.addEventListener('click', ()=>{
    document.body.dataset.theme = document.body.dataset.theme === 'light' ? 'dark' : 'light';
    renderCharts(); // Re-render charts for theme change
  });
  
  // ===== Language Toggle (Feature 1) =====
  langSelect.addEventListener('change', () => {
    currentLang = langSelect.value;
    localStorage.setItem(LANG_KEY, currentLang);
    updateLanguage();
  });

  // ===== Quick Add Buttons (No Change) =====
  quickAddButtons.forEach(button => {
    button.addEventListener('click', () => {
        const addAmount = parseFloat(button.dataset.add);
        let currentAmount = parseFloat(amountInput.value) || 0;
        amountInput.value = (currentAmount + addAmount).toFixed(2);
    });
  });
  
  // NEW: Auto-Fill from Clipboard (Feature 7)
  amountInput.addEventListener('paste', (e) => {
    const text = (e.clipboardData || window.clipboardData).getData('text');
    const numericValue = parseFloat(text.replace(/[^0-9.-]+/g,"")); // Remove non-numeric characters except dot/minus
    if (!isNaN(numericValue) && numericValue > 0) {
        e.preventDefault();
        amountInput.value = numericValue.toFixed(2);
    }
  });

  // ===== Budget Alert Indicator (No Change) =====
  categorySelect.addEventListener('change', () => {
    const selectedCategory = categorySelect.value;
    const isExpense = txType.value === 'expense';
    
    if (selectedCategory && isExpense && categoryBudgets[selectedCategory] && categoryBudgets[selectedCategory].budget > 0) {
        const budget = categoryBudgets[selectedCategory].budget * appSettings.exchangeRate; // Convert budget to internal currency
        
        // Calculate current month's expense for this category (in internal currency)
        const currentMonthBoundaries = getMonthBoundaries(new Date());
        const monthlyExpense = transactions
            .filter(t => t.date >= currentMonthBoundaries.start && t.date <= currentMonthBoundaries.end && t.type === 'expense' && t.category === selectedCategory)
            .reduce((sum, t) => sum + t.amount, 0);

        const remaining = budget - monthlyExpense;
        // const remainingDisplay = convertToDisplayCurrency(remaining);
        // const budgetDisplay = convertToDisplayCurrency(budget);
        
        budgetAlert.style.display = 'block';
        budgetAlert.classList.remove('budget-good', 'budget-warning', 'budget-danger');
        
        if (remaining > 0) {
            const percentUsed = (monthlyExpense / budget) * 100;
            if (percentUsed > 80) {
                budgetAlert.classList.add('budget-warning');
            } else {
                budgetAlert.classList.add('budget-good');
            }
            budgetAlert.textContent = `${getTranslation('budget-left')} ${formatCurrency(remaining)} (Used: ${((monthlyExpense / budget) * 100).toFixed(0)}%)`;
        } else {
            const over = Math.abs(remaining);
            budgetAlert.classList.add('budget-danger');
            budgetAlert.textContent = `${getTranslation('budget-over')} ${formatCurrency(over)}!`;
        }

    } else {
        budgetAlert.style.display = 'none';
    }
  });
  txType.addEventListener('change', () => categorySelect.dispatchEvent(new Event('change'))); // Trigger on type change

  // NEW: Tag Suggestion Logic (Feature 9)
  tagsInput.addEventListener('input', () => {
    const currentValue = tagsInput.value.trim().toLowerCase();
    const lastCommaIndex = currentValue.lastIndexOf(',');
    let currentTag = currentValue;
    let existingTags = '';

    if (lastCommaIndex !== -1) {
        existingTags = currentValue.substring(0, lastCommaIndex + 1);
        currentTag = currentValue.substring(lastCommaIndex + 1).trim();
    }
    
    tagSuggestions.innerHTML = '';

    if (currentTag.length > 0) {
        const matchingTags = Array.from(allTags).filter(tag => tag.toLowerCase().startsWith(currentTag));

        if (matchingTags.length > 0) {
            matchingTags.forEach(tag => {
                const li = document.createElement('li');
                li.textContent = `#${tag}`;
                li.onclick = () => {
                    tagsInput.value = existingTags + tag + ', ';
                    tagSuggestions.style.display = 'none';
                    tagsInput.focus();
                };
                tagSuggestions.appendChild(li);
            });
            tagSuggestions.style.display = 'block';
        } else {
            tagSuggestions.style.display = 'none';
        }
    } else {
        tagSuggestions.style.display = 'none';
    }
  });

  tagsInput.addEventListener('blur', () => {
    // Timeout to allow click on suggestion list
    setTimeout(() => {
        tagSuggestions.style.display = 'none';
    }, 200); 
  });
  tagsInput.addEventListener('focus', () => {
    if (tagSuggestions.innerHTML) {
        tagSuggestions.style.display = 'block';
    }
  });


  // ===== Add / Edit transaction (Local Storage Write) (Updated for Future Date, REMOVED Daily Limit) =====
  txForm.addEventListener('submit', (e) => {
    e.preventDefault();
    
    let finalAmount = parseFloat(amountInput.value) || 0;
    finalAmount = finalAmount * appSettings.exchangeRate; 

    const tx = {
      type: txType.value, 
      amount: finalAmount, 
      category: categorySelect.value || 'Other',
      description: descriptionInput.value || '',
      date: dateInput.value, 
      recurring: recurringSelect.value || 'None',
      tags: tagsInput.value.split(',').map(tag => tag.trim()).filter(tag => tag !== '') || [],
      receiptRef: receiptPlaceholderInput.value || '',
      createdAt: new Date().toISOString()
    };
    
    // NEW: Future Date Warning (Feature 11)
    const today = new Date().toISOString().slice(0, 10);
    if (tx.date > today) {
        showConfirm(
            getTranslation('Warning'),
            getTranslation('future-date-warning', { date: formatDate(tx.date) }),
            () => finalizeTransaction(tx),
            () => {} // Cancel action: do nothing
        );
        return; 
    }

    // REMOVED: Daily Transaction Limit Check (Feature 3)
    // if (!editingTxId) {
    //     const todayTxnCount = transactions.filter(t => t.date === today).length;
    //     const DAILY_LIMIT = 10;
    //     if (todayTxnCount >= DAILY_LIMIT) {
    //         showConfirm(
    //             getTranslation('Warning'),
    //             getTranslation('daily-limit-warning', { count: todayTxnCount + 1 }),
    //             () => finalizeTransaction(tx),
    //             () => {} 
    //         );
    //         return; 
    //     }
    // }
    
    finalizeTransaction(tx);
  });
  
  function finalizeTransaction(tx) {
      
      // Update Smart Category Map
      if (tx.description.trim() !== '') {
          const normDesc = normalizeDescription(tx.description);
          if (tx.category && tx.category !== categorySelect.options[0].value) {
              const catType = categoryBudgets[tx.category] ? categoryBudgets[tx.category].type : tx.type;
              smartCategoryMap[normDesc] = { category: tx.category, type: catType };
              saveSmartCategoryMap(smartCategoryMap);
          }
      }

      let newTransactions = [...transactions];

      if(editingTxId){
          const index = newTransactions.findIndex(t => t.id === editingTxId);
          if (index !== -1) {
              newTransactions[index] = { ...newTransactions[index], ...tx };
              console.log("Transaction updated successfully.");
          }
          editingTxId = null;
      } else {
          tx.id = Date.now().toString() + Math.floor(Math.random() * 10000);
          newTransactions.push(tx);
          console.log("Transaction added successfully.");
      }

      saveTransactions(newTransactions); 
      
      txForm.reset();
      dateInput.value = new Date().toISOString().slice(0,10);
      cancelEditBtn.style.display = 'none';
      budgetAlert.style.display = 'none'; // Hide alert on form reset
  }


  // ===== Add category (Local Storage Write) (No Change) =====
  categoryForm.addEventListener('submit', (e)=>{
    e.preventDefault();

    const val = newCategoryInput.value.trim();
    const type = newCategoryTypeSelect.value; 

    if(val && !categories.includes(val)){
      const newCategoriesList = [...categories, val];
      saveCategories(newCategoriesList); 
      
      categoryBudgets[val] = { budget: 0, type: type };
      saveCategoryBudgets(); 
      
      newCategoryInput.value = '';
      console.log("Category added successfully.");
      updateCategoryOptions(); 
    }
  });
  
  // Smart Category Suggestion (No Change)
  descriptionInput.addEventListener('input', () => {
    const normDesc = normalizeDescription(descriptionInput.value);
    const suggestion = smartCategoryMap[normDesc];

    if (suggestion && categories.includes(suggestion.category)) {
        categorySelect.value = suggestion.category;
        txType.value = suggestion.type; 
        txType.dispatchEvent(new Event('change')); 
    } else if (!editingTxId) {
        categorySelect.value = categorySelect.options[0].value;
        txType.dispatchEvent(new Event('change'));
    }
  });

  /* ===== Filter Utility (Updated for Amount Range) ===== */
  function getFilteredTransactions() {
    // ... (Existing Recurring Logic) ...
    let allTransactions = [...transactions];
    const maxRecurDate = new Date();
    maxRecurDate.setMonth(maxRecurDate.getMonth() + 1); 

    transactions.forEach(t => {
        if (t.recurring === 'None') return;

        let currentDate = new Date(t.date);
        let originalDate = new Date(t.date);

        while (currentDate < maxRecurDate) {
            if (t.recurring === 'Daily') currentDate.setDate(currentDate.getDate() + 1);
            else if (t.recurring === 'Weekly') currentDate.setDate(currentDate.getDate() + 7);
            else if (t.recurring === 'Monthly') currentDate.setMonth(currentDate.getMonth() + 1);
            else break;

            if (currentDate > maxRecurDate) break;

            const newTx = {
                ...t,
                id: `R-${t.id}-${currentDate.getTime()}`,
                date: currentDate.toISOString().slice(0, 10),
                description: `(Recur. from ${originalDate.toISOString().slice(0, 10)}) ${t.description}`,
                isRecur: true,
            };
            allTransactions.push(newTx);
        }
    });

    // Apply filters
    const search = searchInput.value.trim().toLowerCase();
    const fType = filterType.value;
    const fCat = filterCategory.value;
    let from = fromInput.value;
    let to = toInput.value;
    const fTags = filterTagsInput.value.trim().toLowerCase().split(',').map(t => t.trim()).filter(t => t !== '');
    const fMonth = filterMonth.value; 
    const fYear = filterYear.value; 
    
    const minAmount = parseFloat(minAmountInput.value) * appSettings.exchangeRate || 0; // NEW: Amount filter
    const maxAmount = parseFloat(maxAmountInput.value) * appSettings.exchangeRate || Infinity; // NEW: Amount filter

    // Handle Month/Year Filter
    if (fMonth || fYear) {
        const today = new Date();
        let yearToFilter = fYear || today.getFullYear();

        if (fMonth === 'Current') {
            const boundaries = getMonthBoundaries(today);
            from = boundaries.start;
            to = boundaries.end;
        } else if (fMonth) {
            const monthIndex = parseInt(fMonth) - 1;
            const start = new Date(yearToFilter, monthIndex, 1);
            const end = new Date(yearToFilter, monthIndex + 1, 0);
            from = start.toISOString().slice(0, 10);
            to = end.toISOString().slice(0, 10);
        } else if (fYear) {
            const start = new Date(yearToFilter, 0, 1);
            const end = new Date(yearToFilter, 11, 31);
            from = start.toISOString().slice(0, 10);
            to = end.toISOString().slice(0, 10);
        }
    }


    let filtered = allTransactions.filter(t=>{
      if(fType && t.type !== fType) return false;
      if(fCat && t.category !== fCat) return false;
      if(search && !t.description.toLowerCase().includes(search) && !t.category.toLowerCase().includes(search) && !t.tags.some(tag => tag.toLowerCase().includes(search))) return false;
      
      if (fTags.length > 0) {
          const txTags = (Array.isArray(t.tags) ? t.tags : (t.tags || '').split(',')).map(tag => tag.trim().toLowerCase());
          if (!fTags.every(tag => txTags.some(txTag => txTag.includes(tag)))) return false; // Partial tag match
      }

      if(from && t.date < from) return false;
      if(to && t.date > to) return false;
      
      // NEW: Amount Filter (Feature 14)
      if (t.amount < minAmount) return false;
      if (t.amount > maxAmount) return false;
      
      return true;
    });

    filtered.sort((a,b)=> b.date.localeCompare(a.date) || b.createdAt.localeCompare(a.createdAt));
    return filtered;
  }
  
  // NEW: Search Highlight Utility (Feature 6)
  function highlightSearchTerm(text, searchTerm) {
      if (!searchTerm) return text;
      const regex = new RegExp(`(${searchTerm})`, 'gi');
      return text.replace(regex, '<span class="search-highlight">$1</span>');
  }

  /* ===== Render Table (Updated for Running Balance, Search Highlight, and ID Tooltip) ===== */
  function renderTable(){
    const filtered = getFilteredTransactions();
    txTableBody.innerHTML = '';
    
    selectAllTxns.checked = false;
    deleteSelectedTxnsBtn.style.display = 'none';

    // Calculate Running Balance
    const sortedOriginalTxns = transactions.sort((a,b)=> a.date.localeCompare(b.date) || a.createdAt.localeCompare(b.createdAt));
    let runningBalance = 0;
    const balanceMap = {}; 

    sortedOriginalTxns.forEach(t => {
        const amount = t.type === 'income' ? t.amount : -t.amount;
        runningBalance += amount;
        balanceMap[t.id] = runningBalance;
    });

    // Update Filtered Total
    const filteredNetFlow = filtered.reduce((sum, t) => sum + (t.type === 'income' ? t.amount : -t.amount), 0);
    filteredTotalEl.textContent = `${getTranslation('total-filtered')}: ${formatCurrency(filteredNetFlow)}`;
    
    if (filtered.length === 0) {
        txTableBody.innerHTML = `<tr><td colspan="10" style="text-align:center; padding: 20px; color: var(--muted);">No transactions matching current filters.</td></tr>`;
        return;
    }

    const searchTerm = searchInput.value.trim();

    filtered.forEach(t=>{
      const txId = t.id;
      const isRecur = t.isRecur; 
      const tr = document.createElement('tr');
      tr.dataset.id = txId; 
      
      const tagsDisplay = Array.isArray(t.tags) ? t.tags.map(tag => `<span style="background: var(--border-color); padding: 2px 6px; border-radius: 4px; font-size: 0.8rem; margin-right: 4px; display: inline-block;">#${highlightSearchTerm(tag, searchTerm)}</span>`).join('') : '';
      
      const receiptLink = t.receiptRef ? `<a href="${t.receiptRef}" target="_blank" title="${getTranslation('View Receipt')}">üîó</a>` : 'N/A';
      
      // Display running balance for original transactions
      const displayBalance = !isRecur && balanceMap[txId] !== undefined ? formatCurrency(balanceMap[txId]) : 'N/A';
      
      // NEW: Transaction ID Tooltip (Feature 13)
      const dateDisplay = `<span title="TX ID: ${txId}">${formatDate(t.date)}</span>`;
      
      tr.innerHTML = `
        <td style="padding-left: 8px;">
            ${isRecur ? '‚è≥' : `<input type="checkbox" class="tx-checkbox" data-id="${txId}" />`}
        </td>
        <td><span class="badge ${t.type}">${t.type.charAt(0).toUpperCase() + t.type.slice(1)}</span></td>
        <td>${highlightSearchTerm(formatCurrency(t.amount), searchTerm)}</td>
        <td>${highlightSearchTerm(t.category, searchTerm)}</td>
        <td class="muted small">${highlightSearchTerm(t.description || 'N/A', searchTerm)} ${t.receiptRef ? receiptLink : ''}</td>
        <td class="muted small">${tagsDisplay}</td> 
        <td>${dateDisplay}</td>
        <td>${displayBalance}</td>
        <td>${t.recurring}${isRecur ? ' (Sim.)' : ''}</td>
        <td class="actions">
            ${isRecur ? 'N/A' : `<button class="small" data-id="${txId}" onclick="onEditTx('${txId}')">${getTranslation('Edit')}</button>
            <button class="small" data-id="${txId}" onclick="onDeleteTx('${txId}')">${getTranslation('Delete')}</button>
            <button class="small" data-id="${txId}" onclick="onCloneTx('${txId}')" title="${getTranslation('Clone Transaction')}">üìã</button>`}
        </td>
      `;
      txTableBody.appendChild(tr);
    });
    
    attachBulkActionListeners();
  }
  
  // Bulk Actions Logic (No change)
  function attachBulkActionListeners() {
      // ... (Existing Bulk Action Logic) ...
  }
  
  deleteSelectedTxnsBtn.addEventListener('click', handleDeleteSelected);
  function handleDeleteSelected() {
        // ... (Existing Delete Selected Logic) ...
  }

  /* Edit action - global function for inline onclick (No Change) */
  function onEditTx(id){
    // ... (Existing Edit Logic) ...
    const t = transactions.find(x=>x.id===id);
    if(!t) return;
    
    editingTxId = t.id;
    txType.value = t.type;
    amountInput.value = convertToDisplayCurrency(t.amount); 
    categorySelect.value = t.category;
    descriptionInput.value = t.description;
    dateInput.value = t.date;
    recurringSelect.value = t.recurring;
    tagsInput.value = Array.isArray(t.tags) ? t.tags.join(', ') : '';
    receiptPlaceholderInput.value = t.receiptRef || '';
    
    window.scrollTo({top:0, behavior:'smooth'});
    cancelEditBtn.style.display = 'inline-block'; 
    categorySelect.dispatchEvent(new Event('change')); 
  };
  window.onEditTx = onEditTx; 

  /* Clone action - global function for inline onclick (No Change) */
  function onCloneTx(id) {
    const t = transactions.find(x => x.id === id);
    if (!t) return;

    editingTxId = null; 
    txType.value = t.type;
    amountInput.value = convertToDisplayCurrency(t.amount);
    categorySelect.value = t.category;
    descriptionInput.value = t.description;
    dateInput.value = new Date().toISOString().slice(0, 10); 
    recurringSelect.value = 'None'; 
    tagsInput.value = Array.isArray(t.tags) ? t.tags.join(', ') : '';
    receiptPlaceholderInput.value = t.receiptRef || '';

    window.scrollTo({ top: 0, behavior: 'smooth' });
    cancelEditBtn.style.display = 'none'; 
    console.log("Transaction cloned to form.");
    categorySelect.dispatchEvent(new Event('change')); 
  };
  window.onCloneTx = onCloneTx;

  /* Delete action - uses custom modal (No Change) */
  function onDeleteTx(id){
    // ... (Existing Delete Logic) ...
  };
  window.onDeleteTx = onDeleteTx; 

  // --- Utility for getting month boundaries (No Change) ---
  function getMonthBoundaries(date) {
    const d = new Date(date);
    const start = new Date(d.getFullYear(), d.getMonth(), 1);
    const end = new Date(d.getFullYear(), d.getMonth() + 1, 0);
    return {
      start: start.toISOString().slice(0, 10),
      end: end.toISOString().slice(0, 10)
    };
  }
  
  function getPreviousMonthBoundaries(date) {
      const d = new Date(date);
      const prevMonth = new Date(d.getFullYear(), d.getMonth() - 1, 15); // Use mid-month to avoid year rollover issues
      return getMonthBoundaries(prevMonth);
  }
  
  function getTrendIndicator(current, previous, isIncome = false) {
      if (previous === 0) return { text: current > 0 ? 'NEW' : '--', class: current > 0 ? 'trend-good' : 'trend-neutral' };
      const change = current - previous;
      const percentChange = (change / previous) * 100;
      const isGood = isIncome ? change >= 0 : change <= 0;

      let className = 'trend-neutral';
      if (isGood && Math.abs(percentChange) > 5) className = 'trend-good';
      else if (!isGood && Math.abs(percentChange) > 5) className = 'trend-bad';
      
      const sign = percentChange > 0 ? '‚Üë' : (percentChange < 0 ? '‚Üì' : '--');
      const text = `${sign}${Math.abs(percentChange).toFixed(1)}%`;
      return { text, class: className };
  }


  /* ===== Summary (Updated for Net Worth Trend and Trends on Income/Expense) ===== */
  function updateSummary(){
    const safeTxns = transactions.filter(t => t.amount && typeof t.amount === 'number');
    
    // --- Overall Net Worth ---
    const totalIncomeINR = safeTxns.filter(t=>t.type==='income').reduce((s,t)=>s+t.amount,0);
    const totalExpenseINR = safeTxns.filter(t=>t.type==='expense').reduce((s,t)=>s+t.amount,0);
    const netWorthINR = totalIncomeINR - totalExpenseINR;

    netWorthEl.textContent = formatCurrency(netWorthINR); 
    
    // --- Current Month and Previous Month Logic (Trend Analysis) ---
    const today = new Date();
    const currentMonthBoundaries = getMonthBoundaries(today);
    const prevMonthBoundaries = getPreviousMonthBoundaries(today);
    
    const calculateData = (txns, start, end) => {
        const data = txns.filter(t => t.date >= start && t.date <= end);
        const income = data.filter(t=>t.type==='income').reduce((s,t)=>s+t.amount,0);
        const expenses = data.filter(t=>t.type==='expense'); 
        const expenseTotal = expenses.reduce((s,t)=>s+t.amount,0);
        return { income, expenses, expenseTotal };
    };
    
    // Calculate total net worth at the start of the current month
    const originalTxns = safeTxns.filter(t => !t.isRecur);
    const allOriginalTxnsBeforeCurrentMonth = originalTxns.filter(t => t.date < currentMonthBoundaries.start);
    const prevNetWorth = allOriginalTxnsBeforeCurrentMonth.reduce((sum, t) => sum + (t.type === 'income' ? t.amount : -t.amount), 0);
    
    // Net Worth Trend (Feature 8)
    // Compare overall net worth to net worth at start of month
    const netWorthTrendValue = netWorthINR - prevNetWorth;
    const netWorthTrendIndicator = getTrendIndicator(netWorthTrendValue, 0, true); // Treat positive change as good
    netWorthTrend.textContent = netWorthTrendValue === 0 ? '--' : (netWorthTrendValue > 0 ? '‚Üë' : '‚Üì') + formatCurrency(Math.abs(netWorthTrendValue));
    netWorthTrend.classList.remove('trend-good', 'trend-bad', 'trend-neutral');
    netWorthTrend.classList.add(netWorthTrendValue >= 0 ? 'trend-good' : 'trend-bad');
    netWorthTrend.style.display = 'inline-block';


    const currentData = calculateData(safeTxns, currentMonthBoundaries.start, currentMonthBoundaries.end);
    const prevData = calculateData(safeTxns, prevMonthBoundaries.start, prevMonthBoundaries.end);
    
    totalIncomeEl.textContent = formatCurrency(currentData.income);
    totalExpenseEl.textContent = formatCurrency(currentData.expenseTotal);

    // Income Trend
    const incomeTrendIndicator = getTrendIndicator(currentData.income, prevData.income, true);
    incomeTrend.textContent = incomeTrendIndicator.text;
    incomeTrend.className = `trend-badge ${incomeTrendIndicator.class}`;
    incomeTrend.style.display = 'inline-block';

    // Expense Trend
    const expenseTrendIndicator = getTrendIndicator(currentData.expenseTotal, prevData.expenseTotal, false);
    expenseTrend.textContent = expenseTrendIndicator.text;
    expenseTrend.className = `trend-badge ${expenseTrendIndicator.class}`;
    expenseTrend.style.display = 'inline-block';


    // 1. Savings Rate Calculation (No change)
    // ...
    const monthlyNetFlow = currentData.income - currentData.expenseTotal;
    let savingsRate = 0;
    if (currentData.income > 0) {
        savingsRate = (monthlyNetFlow / currentData.income) * 100;
    }
    savingsRateEl.textContent = `${savingsRate.toFixed(0)}%`;
    savingsRateCard.className = `card stat stat-status ${savingsRate >= 20 ? 'status-good' : (savingsRate >= 5 ? 'status-moderate' : 'status-poor')}`;


    // 2. Goal Tracker Logic (No change)
    // ...
    const goal = appSettings.expenseGoal * appSettings.exchangeRate;
    const expenseRatio = goal > 0 ? (currentData.expenseTotal / goal) : 0;
    const percentSpent = Math.min(100, expenseRatio * 100);
    const remainingGoal = goal - currentData.expenseTotal;

    goalStatusText.textContent = `${getTranslation('Goal')}: ${formatCurrency(goal)}`;
    goalRemainingEl.textContent = `${formatCurrency(currentData.expenseTotal)} / ${formatCurrency(goal)} ${getTranslation('Spent')}`;
    goalProgressBarFill.style.width = `${percentSpent}%`;
    
    let goalBarColor = 'var(--success)';
    if (percentSpent > 80 && percentSpent < 100) goalBarColor = 'var(--warning)';
    else if (percentSpent >= 100) goalBarColor = 'var(--danger)';
    goalProgressBarFill.style.background = goalBarColor;


    // Average Daily Expense (No Change)
    const dayOfMonth = today.getDate();
    const avgDailyExpenseINR = currentData.expenseTotal / dayOfMonth; 
    avgDailyExpenseEl.textContent = formatCurrency(avgDailyExpenseINR);

    // Highest Single Expense (No Change)
    const highestTx = currentData.expenses.reduce((max, t) => (t.amount > max.amount ? t : max), { amount: 0, description: 'N/A' });
    highestExpenseEl.textContent = formatCurrency(highestTx.amount);
    highestExpenseDescEl.textContent = highestTx.description;
  }

  /* ===== Charts (Updated for Monthly Bar Chart and Trend Display) ===== */
  function renderCharts(){
    const safeTxns = transactions.filter(t => t.amount && typeof t.amount === 'number' && t.amount > 0);
    
    // Define Chart.js Defaults
    Chart.defaults.font.family = 'Inter';
    Chart.defaults.color = document.body.dataset.theme === 'dark' ? 'rgba(255, 255, 255, 0.7)' : 'rgba(15, 23, 42, 0.7)';
    const primaryColor = getComputedStyle(document.documentElement).getPropertyValue('--primary');
    const successColor = getComputedStyle(document.documentElement).getPropertyValue('--success');
    const dangerColor = getComputedStyle(document.documentElement).getPropertyValue('--danger');
    const accentColor = getComputedStyle(document.documentElement).getPropertyValue('--accent');

    // Utility to get a consistent color for a category
    const getColor = (category, index) => {
        if (!chartColors[category]) {
            const colors = [primaryColor, successColor, dangerColor, accentColor, '#f59e0b', '#8b5cf6', '#ef4444', '#10b981', '#3b82f6'];
            chartColors[category] = colors[index % colors.length];
        }
        return chartColors[category];
    };


    // 1. Expense Allocation Chart (Updated for Trend Display - Feature 5)
    const expenseData = safeTxns.filter(t => t.type === 'expense');
    const expenseMap = expenseData.reduce((map, t) => {
        const category = t.category || 'Other';
        map[category] = (map[category] || 0) + t.amount;
        return map;
    }, {});
    
    // Calculate Previous Month's Expense for Trend
    const today = new Date();
    const prevMonthBoundaries = getPreviousMonthBoundaries(today);
    const prevMonthExpenseData = safeTxns.filter(t => t.type === 'expense' && t.date >= prevMonthBoundaries.start && t.date <= prevMonthBoundaries.end);
    const prevMonthExpenseMap = prevMonthExpenseData.reduce((map, t) => {
        const category = t.category || 'Other';
        map[category] = (map[category] || 0) + t.amount;
        return map;
    }, {});


    const expenseLabels = Object.keys(expenseMap);
    const expenseAmounts = Object.values(expenseMap).map(a => convertToDisplayCurrency(a));
    const totalExpense = expenseAmounts.reduce((s,a)=>s+a,0);
    
    // Add percentage and trend to labels (Feature 5)
    const expenseDisplayLabels = expenseLabels.map((cat, index) => {
        const amount = expenseAmounts[index];
        const percentage = totalExpense > 0 ? (amount / totalExpense) * 100 : 0;
        
        const prevAmount = convertToDisplayCurrency(prevMonthExpenseMap[cat] || 0);
        const trend = getTrendIndicator(amount, prevAmount, false);
        
        // Add trend display
        return `${cat} ${formatCurrency(amount)} (${percentage.toFixed(0)}%) ${trend.text}`;
    });

    const expenseColors = expenseLabels.map(getColor);
    
    if(expenseChart) expenseChart.destroy();
    expenseChart = new Chart(document.getElementById('expense-chart'), {
        type: 'doughnut',
        data: {
            labels: expenseDisplayLabels,
            datasets: [{
                data: expenseAmounts,
                backgroundColor: expenseColors,
                hoverOffset: 4
            }]
        },
        options: {
            responsive: true,
            aspectRatio: 1,
            plugins: {
                legend: {
                    position: 'top',
                    labels: {
                        color: Chart.defaults.color
                    }
                },
                title: {
                    display: true,
                    text: getTranslation('chart-expense-title'),
                    color: Chart.defaults.color
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.label || '';
                            if (label) {
                                label = label.split(' (')[0]; // Remove percent/trend for cleaner tooltip
                            }
                            if (context.parsed !== null) {
                                label += `: ${formatCurrency(context.parsed * appSettings.exchangeRate)}`;
                            }
                            return label;
                        }
                    }
                }
            }
        }
    });

    // 2. Income Distribution Chart (No Change)
    const incomeData = safeTxns.filter(t => t.type === 'income');
    const incomeMap = incomeData.reduce((map, t) => {
        const category = t.category || 'Other';
        map[category] = (map[category] || 0) + t.amount;
        return map;
    }, {});

    const incomeLabels = Object.keys(incomeMap);
    const incomeAmounts = Object.values(incomeMap).map(a => convertToDisplayCurrency(a));
    const incomeColors = incomeLabels.map(getColor);
    
    if(incomeChart) incomeChart.destroy();
    incomeChart = new Chart(document.getElementById('income-chart'), {
        type: 'pie',
        data: {
            labels: incomeLabels,
            datasets: [{
                data: incomeAmounts,
                backgroundColor: incomeColors,
                hoverOffset: 4
            }]
        },
        options: {
            responsive: true,
            aspectRatio: 1,
            plugins: {
                legend: { position: 'top', labels: { color: Chart.defaults.color } },
                title: { display: true, text: getTranslation('chart-income-title'), color: Chart.defaults.color }
            }
        }
    });
    
    // 3. Monthly Net Flow Bar Chart (Feature 4)
    const months = [];
    const monthlyIncome = [];
    const monthlyExpense = [];

    for (let i = 5; i >= 0; i--) {
        const d = new Date();
        d.setMonth(d.getMonth() - i);
        const monthName = d.toLocaleDateString(currentLang, { month: 'short', year: '2-digit' });
        months.push(monthName);

        const boundaries = getMonthBoundaries(d);
        const monthData = safeTxns.filter(t => t.date >= boundaries.start && t.date <= boundaries.end);

        const income = monthData.filter(t => t.type === 'income').reduce((s, t) => s + t.amount, 0);
        const expense = monthData.filter(t => t.type === 'expense').reduce((s, t) => s + t.amount, 0);

        monthlyIncome.push(convertToDisplayCurrency(income));
        monthlyExpense.push(convertToDisplayCurrency(expense));
    }

    if(monthlyBarChart) monthlyBarChart.destroy();
    monthlyBarChart = new Chart(document.getElementById('monthly-bar-chart'), {
        type: 'bar',
        data: {
            labels: months,
            datasets: [
                {
                    label: getTranslation('Total Income'),
                    data: monthlyIncome,
                    backgroundColor: successColor,
                    borderColor: successColor,
                    borderWidth: 1
                },
                {
                    label: getTranslation('Total Expense'),
                    data: monthlyExpense,
                    backgroundColor: dangerColor,
                    borderColor: dangerColor,
                    borderWidth: 1
                }
            ]
        },
        options: {
            responsive: true,
            aspectRatio: 1,
            plugins: {
                legend: { position: 'top', labels: { color: Chart.defaults.color } },
                title: { display: true, text: getTranslation('chart-netflow-title'), color: Chart.defaults.color },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) {
                                label += ': ';
                            }
                            if (context.parsed.y !== null) {
                                label += formatCurrency(context.parsed.y * appSettings.exchangeRate);
                            }
                            return label;
                        }
                    }
                }
            },
            scales: {
                x: { stacked: false, ticks: { color: Chart.defaults.color } },
                y: { stacked: false, ticks: { color: Chart.defaults.color } }
            }
        }
    });

  }

  /* ===== Filters & Controls (Updated for Amount Range) ===== */
  applyFilterBtn.addEventListener('click', ()=>{
    renderTable();
    renderCharts(); 
  });

  resetFilterBtn.addEventListener('click', ()=>{
    searchInput.value=''; filterType.value=''; filterCategory.value=''; fromInput.value=''; toInput.value=''; filterTagsInput.value='';
    filterMonth.value=''; filterYear.value=''; 
    minAmountInput.value=''; maxAmountInput.value=''; // NEW: Reset amount filters
    renderTable();
    renderCharts();
  });

  // Feature: View This Month (No Change)
  viewMonthBtn.addEventListener('click', () => {
      const today = new Date();
      const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
      const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);

      fromInput.value = firstDay.toISOString().slice(0, 10);
      toInput.value = lastDay.toISOString().slice(0, 10);
      
      filterMonth.value = 'Current'; 
      filterYear.value = today.getFullYear(); 

      minAmountInput.value = ''; maxAmountInput.value = ''; // NEW: Clear amount filters
      renderTable();
      renderCharts();
  });

  // Sync Date Range Filter with Month/Year Filters (No Change)
  filterMonth.addEventListener('change', () => {
    if(filterMonth.value || filterYear.value) {
        fromInput.value = '';
        toInput.value = '';
    }
  });
  filterYear.addEventListener('change', () => {
    if(filterMonth.value || filterYear.value) {
        fromInput.value = '';
        toInput.value = '';
    }
  });


  /* ===== Export CSV / PDF / Import (No Change) ===== */
  // ... (Existing Export/Import Logic) ...


  /* ===== Clear all (No Change) ===== */
  clearAllBtn.addEventListener('click', ()=>{
    showConfirm(
      getTranslation('PERMANENT DATA ERASURE'),
      getTranslation('Warning: This action will completely wipe all transactions and reset categories in your Local Storage. Are you certain you wish to proceed?'),
      ()=>{
        const defaultCategories = ["Salary", "Food", "Travel", "Shopping", "Bills", "Other"];
        
        saveTransactions([]); 
        saveCategories(defaultCategories); 
        saveSmartCategoryMap({}); 
        
        categoryBudgets = {};
        saveCategoryBudgets();
        
        localStorage.removeItem(SETTINGS_KEY);
        localStorage.removeItem(PIN_KEY);
        localStorage.removeItem(LANG_KEY); 
        localStorage.removeItem(LAST_BACKUP_KEY); // NEW: Clear backup key
        
        appSettings = {
            baseCurrency: 'INR',
            currencySymbol: '‚Çπ',
            exchangeRate: 1.0, 
            expenseGoal: 0,
            pinActive: false,
            dateFormat: 'DD/MM/YYYY', // Reset Date Format
        };
        currentPin = null;
        currentLang = 'en'; 
        allTags.clear(); // Clear all tags
        
        loadSettings(); 
        initUI();
        updateLanguage(); 
        
        console.log("All data cleared successfully and reset to default.");
      }
    );
  });

  /* ===== Settings Modal Logic (Updated for Date Format) ===== */
  settingsBtn.addEventListener('click', () => {
      // Load current settings into the modal inputs
      currencySelect.value = appSettings.baseCurrency;
      goalInput.value = appSettings.expenseGoal;
      setPinInput.value = ''; 
      dateFormatSelect.value = appSettings.dateFormat; // NEW: Set date format value
      updateCategoryOptions(); 
      settingsModal.style.display = 'flex';
  });

  closeSettingsBtn.addEventListener('click', () => {
      settingsModal.style.display = 'none';
  });

  saveSettingsBtn.addEventListener('click', () => {
      const newCurrency = currencySelect.value;
      const newGoal = parseFloat(goalInput.value) || 0;
      const newPin = setPinInput.value.trim();
      const newDateFormat = dateFormatSelect.value; // NEW: Get date format

      // 1. Currency Update (No Change)
      if (EXCHANGE_RATES[newCurrency]) {
          const rateData = EXCHANGE_RATES[newCurrency];
          appSettings.baseCurrency = newCurrency;
          appSettings.currencySymbol = rateData.symbol;
          appSettings.exchangeRate = rateData.rate; 
      } else {
          showConfirm(getTranslation("Error"), getTranslation("Invalid currency selection."), ()=>{});
          return;
      }
      
      // 2. Date Format Update (Feature 15)
      appSettings.dateFormat = newDateFormat;

      // 3. Goal Update (No Change)
      appSettings.expenseGoal = Math.max(0, newGoal);

      // 4. Category Budgets Update (No Change)
      const budgetInputs = document.querySelectorAll('.category-budget-input');
      budgetInputs.forEach(input => {
          const cat = input.dataset.cat;
          const budget = parseFloat(input.value) || 0;
          if (categoryBudgets[cat]) {
              categoryBudgets[cat].budget = Math.max(0, budget);
          } else {
              categoryBudgets[cat] = { budget: Math.max(0, budget), type: 'expense' };
          }
      });
      saveCategoryBudgets();

      // 5. PIN Update (No Change)
      if (newPin.length > 0 && newPin.length !== 4) {
          showConfirm(getTranslation("Error"), getTranslation("PIN must be exactly 4 digits. Leave blank to keep current or clear."), ()=>{});
          return;
      } else if (newPin.length === 4) {
          currentPin = newPin;
      } else if (newPin.length === 0) {
          currentPin = null;
      }
      
      saveSettings(); 
      settingsModal.style.display = 'none';
      updateGreeting(); 
  });
  // --------------------------------------------------

  /* ===== UI Helpers ===== */
  txForm.addEventListener('change', ()=> {
    if (editingTxId) cancelEditBtn.style.display = 'inline-block';
  });
  txForm.addEventListener('input', ()=> {
    if (editingTxId) cancelEditBtn.style.display = 'inline-block';
  });
  
  // Custom Modal implementation (No change, uses i18n for strings if possible)
  function showConfirm(title, message, callback, cancelCallback) {
        document.getElementById('modal-title').textContent = title;
        document.getElementById('modal-message').textContent = message;
        document.getElementById('modal-confirm').textContent = getTranslation('modal-confirm');
        document.getElementById('modal-cancel').textContent = getTranslation('modal-cancel');
        document.getElementById('modal-overlay').style.display = 'flex';

        const confirmHandler = () => {
            document.getElementById('modal-overlay').style.display = 'none';
            callback();
            removeListeners();
        };

        const cancelHandler = () => {
            document.getElementById('modal-overlay').style.display = 'none';
            if(cancelCallback) cancelCallback();
            removeListeners();
        };

        const removeListeners = () => {
            document.getElementById('modal-confirm').removeEventListener('click', confirmHandler);
            document.getElementById('modal-cancel').removeEventListener('click', cancelHandler);
        };

        document.getElementById('modal-confirm').addEventListener('click', confirmHandler);
        document.getElementById('modal-cancel').addEventListener('click', cancelHandler);
    }
    window.showConfirm = showConfirm; // Make it global
    
    // Unlock Logic (No Change)
    unlockBtn.addEventListener('click', () => {
        if (pinInput.value === currentPin) {
            lockScreen.style.display = 'none';
            document.body.style.overflow = '';
            sessionStorage.setItem('unlocked', 'true');
            pinError.textContent = '';
            // Load content after unlock if it wasn't loaded before
            if (transactions.length === 0) { 
                initializeAppContent();
            }
        } else {
            pinError.textContent = getTranslation('Incorrect PIN. Try again.');
            pinInput.value = '';
        }
    });

    pinInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            unlockBtn.click();
        }
    });
</script>

</body>
</html>
